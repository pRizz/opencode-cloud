#cloud-config

# =============================================================================
# opencode-cloud AWS Quick Deploy (cloud-init)
# =============================================================================
# This script installs Docker, runs the opencode-cloud sandbox container, and
# creates an initial PAM user with a strong random password.
#
# CloudFormation substitutes the variables below when used as EC2 UserData.
# To run standalone, replace the ${...} values in /etc/opencode-cloud/stack.env.
# =============================================================================

package_update: true
package_upgrade: false
packages:
  - docker.io
  - curl
  - jq
  - build-essential
  - pkg-config
  - libssl-dev

write_files:
  - path: /etc/opencode-cloud/stack.env
    permissions: "0600"
    content: |
      OPENCODE_IMAGE=${OPENCODE_IMAGE}
      OPENCODE_CONTAINER_NAME=${OPENCODE_CONTAINER_NAME}
      OPENCODE_USERNAME=${OPENCODE_USERNAME}
      OPENCODE_DOMAIN_URL=${OPENCODE_DOMAIN_URL}
      OPENCODE_ALB_URL=${OPENCODE_ALB_URL}
      COCKPIT_DOMAIN_URL=${COCKPIT_DOMAIN_URL}
      COCKPIT_ALB_URL=${COCKPIT_ALB_URL}
  - path: /usr/local/bin/opencode-cloud-setup.sh
    permissions: "0755"
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      STATUS_DIR="/var/lib/opencode-cloud"
      STATUS_FILE="${STATUS_DIR}/deploy-status.json"
      PROVISIONED_FILE="${STATUS_DIR}/.provisioned"
      LOG_FILE="/var/log/opencode-cloud-setup.log"

      log() {
        printf '%s %s\n' "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" "$*" >> "$LOG_FILE"
      }

      log "opencode-cloud setup (cloud-init): start"

      if [ -f "${PROVISIONED_FILE}" ]; then
        log "opencode-cloud setup: already provisioned"
        echo "opencode-cloud: already provisioned"
        exit 0
      fi

      log "opencode-cloud setup: prepare status dir"
      mkdir -p "${STATUS_DIR}"
      chmod 700 "${STATUS_DIR}"
      log "opencode-cloud setup: status dir ready"

      # Load CloudFormation-provided values.
      if [ -f /etc/opencode-cloud/stack.env ]; then
        log "opencode-cloud setup: load stack env"
        # shellcheck disable=SC1091
        source /etc/opencode-cloud/stack.env
        log "opencode-cloud setup: stack env loaded"
      fi

      : "${OPENCODE_IMAGE:=ghcr.io/prizz/opencode-cloud-sandbox:latest}"
      : "${OPENCODE_CONTAINER_NAME:=opencode-cloud-sandbox}"
      : "${OPENCODE_USERNAME:=opencode}"
      : "${OPENCODE_DOMAIN_URL:=}"
      : "${OPENCODE_ALB_URL:=}"
      : "${COCKPIT_DOMAIN_URL:=}"
      : "${COCKPIT_ALB_URL:=}"

      if ! command -v cargo >/dev/null 2>&1; then
        log "opencode-cloud setup: install rust toolchain"
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | \
          bash -s -- -y --profile minimal --default-toolchain 1.85.0
        log "opencode-cloud setup: rust toolchain installed"
      fi

      export PATH="$HOME/.cargo/bin:${PATH}"

      if ! command -v opencode-cloud >/dev/null 2>&1; then
        log "opencode-cloud setup: install opencode-cloud CLI"
        cargo install opencode-cloud
        log "opencode-cloud setup: opencode-cloud CLI installed"
      fi

      OPENCODE_CLI_VERSION="$(opencode-cloud --version 2>/dev/null || true)"

      log "opencode-cloud setup: enable docker"
      systemctl enable --now docker
      log "opencode-cloud setup: docker enabled"

      log "opencode-cloud setup: pull image ${OPENCODE_IMAGE}"
      docker pull "${OPENCODE_IMAGE}"
      log "opencode-cloud setup: image pulled"

      log "opencode-cloud setup: create volumes"
      docker volume create opencode-config >/dev/null
      docker volume create opencode-data >/dev/null
      docker volume create opencode-workspace >/dev/null
      log "opencode-cloud setup: volumes ready"

      if ! docker ps -a --format '{{.Names}}' | grep -qx "${OPENCODE_CONTAINER_NAME}"; then
        log "opencode-cloud setup: start container ${OPENCODE_CONTAINER_NAME}"
        docker run -d \
          --name "${OPENCODE_CONTAINER_NAME}" \
          --restart unless-stopped \
          -p 3000:3000 \
          -p 9090:9090 \
          -v opencode-config:/home/opencode/.config \
          -v opencode-data:/home/opencode/.local/share \
          -v opencode-workspace:/home/opencode/workspace \
          "${OPENCODE_IMAGE}"
        log "opencode-cloud setup: container started"
      fi

      # Wait for the container to be ready to accept commands.
      log "opencode-cloud setup: wait for container readiness"
      for _ in $(seq 1 30); do
        if docker exec "${OPENCODE_CONTAINER_NAME}" true >/dev/null 2>&1; then
          break
        fi
        sleep 2
      done
      log "opencode-cloud setup: container ready for exec"

      if ! docker exec "${OPENCODE_CONTAINER_NAME}" id -u "${OPENCODE_USERNAME}" >/dev/null 2>&1; then
        log "opencode-cloud setup: create user ${OPENCODE_USERNAME}"
        docker exec "${OPENCODE_CONTAINER_NAME}" useradd -m -s /bin/bash "${OPENCODE_USERNAME}"
        docker exec "${OPENCODE_CONTAINER_NAME}" usermod -aG sudo "${OPENCODE_USERNAME}"
        log "opencode-cloud setup: user created"
      fi

      log "opencode-cloud setup: set user password"
      OPENCODE_PASSWORD="$(tr -dc 'A-Za-z0-9' </dev/urandom | head -c 24)"
      echo "${OPENCODE_USERNAME}:${OPENCODE_PASSWORD}" | docker exec -i "${OPENCODE_CONTAINER_NAME}" chpasswd
      log "opencode-cloud setup: user password set"

      log "opencode-cloud setup: write status file"
      cat > "${STATUS_FILE}" <<EOF
      {
        "opencode_url": "${OPENCODE_DOMAIN_URL}",
        "opencode_alb_url": "${OPENCODE_ALB_URL}",
        "cockpit_url": "${COCKPIT_DOMAIN_URL}",
        "cockpit_alb_url": "${COCKPIT_ALB_URL}",
        "username": "${OPENCODE_USERNAME}",
        "password": "${OPENCODE_PASSWORD}",
        "container": "${OPENCODE_CONTAINER_NAME}",
        "image": "${OPENCODE_IMAGE}",
        "cli_version": "${OPENCODE_CLI_VERSION}"
      }
      EOF
      chmod 600 "${STATUS_FILE}"
      log "opencode-cloud setup: status file written"

      log "opencode-cloud setup: write motd"
      cat > /etc/motd <<EOF
      opencode-cloud ready.
      Username: ${OPENCODE_USERNAME}
      Password: ${OPENCODE_PASSWORD}
      opencode: ${OPENCODE_DOMAIN_URL}
      Cockpit: ${COCKPIT_DOMAIN_URL}
      Status file: ${STATUS_FILE}
      EOF
      log "opencode-cloud setup: motd written"

      log "opencode-cloud setup: mark provisioned"
      date -u +"%Y-%m-%dT%H:%M:%SZ" > "${PROVISIONED_FILE}"
      log "opencode-cloud setup: complete"

runcmd:
  - [bash, -lc, "/usr/local/bin/opencode-cloud-setup.sh"]
