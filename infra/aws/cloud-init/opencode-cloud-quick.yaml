#cloud-config

# =============================================================================
# opencode-cloud AWS Quick Deploy (cloud-init)
# =============================================================================
# This script installs Docker, runs the opencode-cloud sandbox container, and
# creates an initial PAM user with a strong random password.
#
# CloudFormation substitutes the variables below when used as EC2 UserData.
# To run standalone, replace the ${...} values in /etc/opencode-cloud/stack.env.
# =============================================================================

package_update: true
package_upgrade: false
packages:
  - docker.io
  - curl
  - jq
  - build-essential
  - pkg-config
  - libssl-dev

write_files:
  - path: /etc/opencode-cloud/stack.env
    permissions: "0600"
    content: |
      OPENCODE_IMAGE=${OPENCODE_IMAGE}
      OPENCODE_CONTAINER_NAME=${OPENCODE_CONTAINER_NAME}
      OPENCODE_USERNAME=${OPENCODE_USERNAME}
      OPENCODE_DOMAIN_URL=${OPENCODE_DOMAIN_URL}
      OPENCODE_ALB_URL=${OPENCODE_ALB_URL}
  - path: /usr/local/bin/opencode-cloud-setup.sh
    permissions: "0755"
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      OPENCODE_SETUP_BASE_URL="https://raw.githubusercontent.com/pRizz/opencode-cloud/main/scripts/provisioning"
      OPENCODE_SETUP_DEST="/usr/local/bin"

      fetch_script() {
        local name="$1"
        local tmp_path

        tmp_path="$(mktemp)"
        curl -sSfL "$OPENCODE_SETUP_BASE_URL/$name" -o "$tmp_path"
        install -m 0755 "$tmp_path" "$OPENCODE_SETUP_DEST/$name"
        chown root:root "$OPENCODE_SETUP_DEST/$name"
        rm -f "$tmp_path"
      }

      fetch_script "opencode-cloud-setup.sh"
      fetch_script "opencode-cloud-setup-cloudformation.sh"
      fetch_script "opencode-cloud-setup-cloud-init.sh"

      exec "$OPENCODE_SETUP_DEST/opencode-cloud-setup-cloud-init.sh"

runcmd:
  - [bash, -lc, "/usr/local/bin/opencode-cloud-setup.sh"]
