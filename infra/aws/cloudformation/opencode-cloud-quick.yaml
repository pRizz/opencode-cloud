AWSTemplateFormatVersion: "2010-09-09"
Description: opencode-cloud quick deploy (ALB + ACM + private EC2 + cloud-init)

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Required"
        Parameters:
          - DomainName
      - Label:
          default: "Advanced: Instance"
        Parameters:
          - InstanceType
          - RootVolumeSize
          - KeyPairName
          - OpencodeUsername
      - Label:
          default: "Advanced: Networking"
        Parameters:
          - UseExistingVpc
          - ExistingVpcId
          - ExistingPublicSubnetIds
          - ExistingPrivateSubnetId
          - AllowSsh
      - Label:
          default: "Advanced: TLS"
        Parameters:
          - HostedZoneId

Parameters:
  DomainName:
    Type: String
    # TODO: Elaborate on this; must they use a domain they already own or can they use a brand new one?
    MinLength: 3
    MaxLength: 253
    AllowedPattern: "^(?=.{1,253}$)(?!-)(?:[A-Za-z0-9](?:[A-Za-z0-9-]{0,61}[A-Za-z0-9])?\\.)+[A-Za-z]{2,63}$"
    ConstraintDescription: "Provide a valid FQDN (e.g., opencode.example.com)."
    Description: "Fully-qualified domain name for HTTPS (ACM certificate validation required). This should be compatible with the HostedZone you provided. For example, if the HostedZone is 'example.com', the DomainName could be 'opencode.example.com'."
  HostedZoneId:
    Type: AWS::Route53::HostedZone::Id
    Description: "Route53 hosted zone ID for DNS validation. This should be compatible with the DomainName you provided. For example, if the DomainName is 'opencode.example.com', the HostedZoneId has to be the ID of the 'example.com' hosted zone."
  InstanceType:
    Type: String
    Default: t3.medium
    AllowedValues:
      - t3.micro
      - t3.small
      - t3.medium
      - t3.large
      - t3.xlarge
      - t3a.micro
      - t3a.small
      - t3a.medium
      - t3a.large
    Description: "EC2 instance type for opencode-cloud. Smaller sizes (t3/t3a micro or small) may be unstable under load."
  RootVolumeSize:
    Type: Number
    Default: 30
    MinValue: 16
    Description: "Root EBS volume size in GiB."
  KeyPairName:
    Type: String
    Default: ""
    Description: "Optional EC2 key pair name (not ID) for SSH access (credentials are available in Secrets Manager)."
  OpencodeUsername:
    Type: String
    Default: opencode
    Description: "Initial opencode username created during provisioning. This is in addition to the default ubuntu user which has no password but is only accessible via SSH."
  UseExistingVpc:
    Type: String
    Default: "false"
    AllowedValues:
      - "true"
      - "false"
    Description: "Use existing VPC/subnets instead of creating a new VPC."
  ExistingVpcId:
    Type: AWS::EC2::VPC::Id
    Default: vpc-00000000
    Description: "Existing VPC ID (required if UseExistingVpc=true)."
  ExistingPublicSubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Default: subnet-00000000,subnet-00000000
    Description: "Existing public subnet IDs for the ALB (required if UseExistingVpc=true)."
  ExistingPrivateSubnetId:
    Type: AWS::EC2::Subnet::Id
    Default: subnet-00000000
    Description: "Existing private subnet ID for the EC2 instance (required if UseExistingVpc=true)."
  AllowSsh:
    Type: String
    Default: "false"
    AllowedValues:
      - "true"
      - "false"
    Description: "Allow SSH access to the instance. When false, access is via AWS Systems Manager (SSM) Session Manager, or via other VPC paths (bastion/VPN)."
  UbuntuAmiId:
    Type: "AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>"
    Default: "/aws/service/canonical/ubuntu/server/24.04/stable/current/amd64/hvm/ebs-gp3/ami-id"
    Description: "Ubuntu 24.04 LTS AMI (SSM public parameter)."

Conditions:
  UseExistingVpcCondition: !Equals [!Ref UseExistingVpc, "true"]
  CreateVpc: !Equals [!Ref UseExistingVpc, "false"]
  UseKeyPair: !Not [!Equals [!Ref KeyPairName, ""]]
  AllowSshCondition: !Equals [!Ref AllowSsh, "true"]

Rules:
  ExistingVpcRequired:
    RuleCondition: !Equals [!Ref UseExistingVpc, "true"]
    Assertions:
      - Assert: !Not [!Equals [!Ref ExistingVpcId, "vpc-00000000"]]
        AssertDescription: "ExistingVpcId must be a real VPC ID when UseExistingVpc=true."
      - Assert: !Not [!Contains [!Ref ExistingPublicSubnetIds, "subnet-00000000"]]
        AssertDescription: "ExistingPublicSubnetIds must be real subnet IDs when UseExistingVpc=true."
      - Assert: !Not [!Equals [!Ref ExistingPrivateSubnetId, "subnet-00000000"]]
        AssertDescription: "ExistingPrivateSubnetId must be a real subnet ID when UseExistingVpc=true."
Resources:
  CredentialsSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub "opencode-cloud/${AWS::StackName}/credentials"
      Description: "opencode-cloud bootstrap credentials"

  Vpc:
    Type: AWS::EC2::VPC
    Condition: CreateVpc
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: opencode-cloud-quick-vpc

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Condition: CreateVpc
    Properties:
      Tags:
        - Key: Name
          Value: opencode-cloud-quick-igw

  VpcGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Condition: CreateVpc
    Properties:
      VpcId: !Ref Vpc
      InternetGatewayId: !Ref InternetGateway

  PublicSubnetA:
    Type: AWS::EC2::Subnet
    Condition: CreateVpc
    Properties:
      VpcId: !Ref Vpc
      AvailabilityZone: !Select [0, !GetAZs ""]
      CidrBlock: 10.0.0.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: opencode-cloud-quick-public-a

  PublicSubnetB:
    Type: AWS::EC2::Subnet
    Condition: CreateVpc
    Properties:
      VpcId: !Ref Vpc
      AvailabilityZone: !Select [1, !GetAZs ""]
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: opencode-cloud-quick-public-b

  PrivateSubnetA:
    Type: AWS::EC2::Subnet
    Condition: CreateVpc
    Properties:
      VpcId: !Ref Vpc
      AvailabilityZone: !Select [0, !GetAZs ""]
      CidrBlock: 10.0.10.0/24
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: opencode-cloud-quick-private-a

  PrivateSubnetB:
    Type: AWS::EC2::Subnet
    Condition: CreateVpc
    Properties:
      VpcId: !Ref Vpc
      AvailabilityZone: !Select [1, !GetAZs ""]
      CidrBlock: 10.0.11.0/24
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: opencode-cloud-quick-private-b

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Condition: CreateVpc
    Properties:
      VpcId: !Ref Vpc
      Tags:
        - Key: Name
          Value: opencode-cloud-quick-public-rt

  PublicRoute:
    Type: AWS::EC2::Route
    Condition: CreateVpc
    DependsOn: VpcGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnetRouteTableAssociationA:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: CreateVpc
    Properties:
      SubnetId: !Ref PublicSubnetA
      RouteTableId: !Ref PublicRouteTable

  PublicSubnetRouteTableAssociationB:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: CreateVpc
    Properties:
      SubnetId: !Ref PublicSubnetB
      RouteTableId: !Ref PublicRouteTable

  NatEip:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

  NatGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatEip.AllocationId
      SubnetId: !If
        - UseExistingVpcCondition
        - !Select [0, !Ref ExistingPublicSubnetIds]
        - !Ref PublicSubnetA
      Tags:
        - Key: Name
          Value: opencode-cloud-quick-nat

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !If [UseExistingVpcCondition, !Ref ExistingVpcId, !Ref Vpc]
      Tags:
        - Key: Name
          Value: opencode-cloud-quick-private-rt

  PrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

  PrivateSubnetRouteTableAssociationA:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: CreateVpc
    Properties:
      SubnetId: !Ref PrivateSubnetA
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnetRouteTableAssociationB:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: CreateVpc
    Properties:
      SubnetId: !Ref PrivateSubnetB
      RouteTableId: !Ref PrivateRouteTable

  ExistingPrivateSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: UseExistingVpcCondition
    Properties:
      SubnetId: !Ref ExistingPrivateSubnetId
      RouteTableId: !Ref PrivateRouteTable

  AlbSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: opencode-cloud ALB security group
      VpcId: !If [UseExistingVpcCondition, !Ref ExistingVpcId, !Ref Vpc]
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0

  InstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: opencode-cloud instance security group
      VpcId: !If [UseExistingVpcCondition, !Ref ExistingVpcId, !Ref Vpc]
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3000
          ToPort: 3000
          SourceSecurityGroupId: !Ref AlbSecurityGroup
        - IpProtocol: tcp
          FromPort: 9090
          ToPort: 9090
          SourceSecurityGroupId: !Ref AlbSecurityGroup
        - !If
          - AllowSshCondition
          - IpProtocol: tcp
            FromPort: 22
            ToPort: 22
            CidrIp: 0.0.0.0/0
          - !Ref "AWS::NoValue"
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0

  InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Policies:
        - PolicyName: opencode-credentials-secret-write
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:PutSecretValue
                  - secretsmanager:DescribeSecret
                Resource: !Ref CredentialsSecret
      Path: /

  InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
        - !Ref InstanceRole

  Certificate:
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName: !Ref DomainName
      ValidationMethod: DNS
      DomainValidationOptions:
        - DomainName: !Ref DomainName
          HostedZoneId: !Ref HostedZoneId

  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub "${AWS::StackName}-alb"
      Scheme: internet-facing
      Type: application
      SecurityGroups:
        - !Ref AlbSecurityGroup
      Subnets: !If
        - UseExistingVpcCondition
        - !Ref ExistingPublicSubnetIds
        - - !Ref PublicSubnetA
          - !Ref PublicSubnetB

  OpencodeTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${AWS::StackName}-web"
      Port: 3000
      Protocol: HTTP
      VpcId: !If [UseExistingVpcCondition, !Ref ExistingVpcId, !Ref Vpc]
      TargetType: instance
      HealthCheckPath: /health
      Matcher:
        HttpCode: "200-399"
      Targets:
        - Id: !Ref OpencodeInstance
          Port: 3000

  CockpitTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${AWS::StackName}-cockpit"
      Port: 9090
      Protocol: HTTP
      VpcId: !If [UseExistingVpcCondition, !Ref ExistingVpcId, !Ref Vpc]
      TargetType: instance
      HealthCheckPath: /cockpit
      Matcher:
        HttpCode: "200-399"
      Targets:
        - Id: !Ref OpencodeInstance
          Port: 9090

  HttpListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: redirect
          RedirectConfig:
            Protocol: HTTPS
            Port: "443"
            StatusCode: HTTP_301

  HttpsListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 443
      Protocol: HTTPS
      Certificates:
        - CertificateArn: !Ref Certificate
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref OpencodeTargetGroup

  CockpitListenerRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref HttpsListener
      Priority: 10
      Conditions:
        - Field: path-pattern
          Values:
            - /cockpit*
      Actions:
        - Type: forward
          TargetGroupArn: !Ref CockpitTargetGroup

  OpencodeInstance:
    Type: AWS::EC2::Instance
    CreationPolicy:
      ResourceSignal:
        Timeout: PT30M
        Count: 1
    Properties:
      ImageId: !Ref UbuntuAmiId
      InstanceType: !Ref InstanceType
      IamInstanceProfile: !Ref InstanceProfile
      KeyName: !If [UseKeyPair, !Ref KeyPairName, !Ref "AWS::NoValue"]
      Tags:
        - Key: Name
          Value: !Sub "opencode-cloud-${AWS::StackName}"
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: !Ref RootVolumeSize
            VolumeType: gp3
            DeleteOnTermination: true
      NetworkInterfaces:
        - DeviceIndex: "0"
          AssociatePublicIpAddress: false
          SubnetId: !If
            - UseExistingVpcCondition
            - !Ref ExistingPrivateSubnetId
            - !Ref PrivateSubnetA
          GroupSet:
            - !Ref InstanceSecurityGroup
      UserData:
        Fn::Base64:
          Fn::Sub: |
            #cloud-config
            apt:
              conf: |
                Acquire::ForceIPv4 "true";
            package_update: true
            package_upgrade: false
            packages:
              - aws-cfn-bootstrap
              - awscli
              - curl
              - docker.io
              - jq
            write_files:
              - path: /etc/opencode-cloud/stack.env
                permissions: "0600"
                content: |
                  OPENCODE_IMAGE=ghcr.io/prizz/opencode-cloud-sandbox:latest
                  OPENCODE_CONTAINER_NAME=opencode-cloud-sandbox
                  OPENCODE_USERNAME=${OpencodeUsername}
                  OPENCODE_DOMAIN_URL=https://${DomainName}
                  OPENCODE_ALB_URL=https://${ApplicationLoadBalancer.DNSName}
                  COCKPIT_DOMAIN_URL=https://${DomainName}/cockpit
                  COCKPIT_ALB_URL=https://${ApplicationLoadBalancer.DNSName}/cockpit
                  OPENCODE_CREDENTIALS_SECRET_ARN=${CredentialsSecret}
                  AWS_REGION=${AWS::Region}
              - path: /etc/motd
                permissions: "0644"
                content: |
                  opencode-cloud ready. (cloudformation)
                  debug logs: /var/log/opencode-cloud-setup.log
                  Username: ${OpencodeUsername}
                  opencode: https://${DomainName}
                  Cockpit: https://${DomainName}/cockpit
                  Credentials secret: ${CredentialsSecret}
                  Fetch credentials:
                    aws secretsmanager get-secret-value --region ${AWS::Region} \
                      --secret-id ${CredentialsSecret} \
                      --query SecretString --output text
              - path: /usr/local/bin/opencode-cloud-setup.sh
                permissions: "0755"
                content: |
                  #!/usr/bin/env bash
                  set -euo pipefail
                  STATUS_DIR="/var/lib/opencode-cloud"
                  PROVISIONED_FILE="$STATUS_DIR/.provisioned"
                  STACK_NAME="${AWS::StackName}"
                  SIGNAL_RESOURCE="OpencodeInstance"
                  SIGNAL_BIN="/opt/aws/bin/cfn-signal"
                  LOG_FILE="/var/log/opencode-cloud-setup.log"

                  log() {
                    printf '%s %s\n' "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" "$*" >> "$LOG_FILE"
                  }

                  home_value="$(printenv HOME 2>/dev/null || true)"
                  path_value="$(printenv PATH 2>/dev/null || true)"
                  if [ -z "$home_value" ]; then
                    log "opencode-cloud setup: HOME is unset"
                  else
                    log "opencode-cloud setup: HOME before set: $home_value"
                  fi
                  log "opencode-cloud setup: PATH before set: $path_value"

                  export HOME="/root"

                  log "opencode-cloud setup (cloudformation): start"

                  signal_result() {
                    local -r exit_code="$1"
                    local -r reason="$2"

                    if [ -x "$SIGNAL_BIN" ]; then
                      "$SIGNAL_BIN" \
                        --exit-code "$exit_code" \
                        --stack "$STACK_NAME" \
                        --resource "$SIGNAL_RESOURCE" \
                        --region "${AWS::Region}" \
                        --reason "$reason"
                    fi

                    if [ "$exit_code" -ne 0 ]; then
                      exit "$exit_code"
                    fi
                  }
                  trap 'signal_result 1 "opencode-cloud bootstrap failed"' ERR

                  if [ -f "$PROVISIONED_FILE" ]; then
                    log "opencode-cloud setup: already provisioned"
                    echo "opencode-cloud: already provisioned"
                    signal_result 0 "opencode-cloud already provisioned"
                    exit 0
                  fi

                  log "opencode-cloud setup: prepare status dir"
                  mkdir -p "$STATUS_DIR"
                  chmod 700 "$STATUS_DIR"
                  log "opencode-cloud setup: status dir ready"

                  if [ -f /etc/opencode-cloud/stack.env ]; then
                    log "opencode-cloud setup: load stack env"
                    # shellcheck disable=SC1091
                    source /etc/opencode-cloud/stack.env
                    log "opencode-cloud setup: stack env loaded"
                  fi

                  if [ -z "$OPENCODE_IMAGE" ]; then
                    OPENCODE_IMAGE="ghcr.io/prizz/opencode-cloud-sandbox:latest"
                  fi

                  if [ -z "$OPENCODE_CONTAINER_NAME" ]; then
                    OPENCODE_CONTAINER_NAME="opencode-cloud-sandbox"
                  fi

                  if [ -z "$OPENCODE_USERNAME" ]; then
                    OPENCODE_USERNAME="opencode"
                  fi

                  if [ -z "$OPENCODE_DOMAIN_URL" ]; then
                    log "opencode-cloud setup: missing OPENCODE_DOMAIN_URL"
                    echo "opencode-cloud: missing OPENCODE_DOMAIN_URL"
                    signal_result 1 "opencode-cloud missing OPENCODE_DOMAIN_URL"
                    exit 1
                  fi

                  if [ -z "$OPENCODE_ALB_URL" ]; then
                    log "opencode-cloud setup: missing OPENCODE_ALB_URL"
                    echo "opencode-cloud: missing OPENCODE_ALB_URL"
                    signal_result 1 "opencode-cloud missing OPENCODE_ALB_URL"
                    exit 1
                  fi

                  if [ -z "$COCKPIT_DOMAIN_URL" ]; then
                    COCKPIT_DOMAIN_URL=""
                  fi

                  if [ -z "$COCKPIT_ALB_URL" ]; then
                    COCKPIT_ALB_URL=""
                  fi

                  if [ -z "$OPENCODE_CREDENTIALS_SECRET_ARN" ]; then
                    log "opencode-cloud setup: missing credentials secret ARN"
                    echo "opencode-cloud: missing credentials secret ARN"
                    signal_result 1 "opencode-cloud missing credentials secret ARN"
                    exit 1
                  fi

                  if [ -z "$AWS_REGION" ]; then
                    log "opencode-cloud setup: missing AWS region"
                    echo "opencode-cloud: missing AWS region"
                    signal_result 1 "opencode-cloud missing AWS region"
                    exit 1
                  fi

                  if ! command -v cargo >/dev/null 2>&1; then
                    log "opencode-cloud setup: install rust toolchain"
                    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | \
                      bash -s -- -y --profile minimal --default-toolchain 1.85.0
                    log "opencode-cloud setup: rust toolchain installed"
                  fi

                  log current path: "$PATH"
                  log "opencode-cloud setup: current cargo path: $(which cargo)"
                  version="$(cargo --version)"
                  log "opencode-cloud setup: current cargo version: $version"
                  log "opencode-cloud setup: set PATH"
                  export PATH="$HOME/.cargo/bin:$PATH"
                  log "opencode-cloud setup: PATH set"

                  if ! command -v opencode-cloud >/dev/null 2>&1; then
                    log "opencode-cloud setup: install opencode-cloud CLI"
                    cargo install opencode-cloud
                    log "opencode-cloud setup: opencode-cloud CLI installed"
                  fi
                  log "opencode-cloud setup: current opencode-cloud path: $(which opencode-cloud)"
                  version="$(opencode-cloud --version)"
                  log "opencode-cloud setup: current opencode-cloud version: $version"

                  log "opencode-cloud setup: enable docker"
                  systemctl enable --now docker
                  log "opencode-cloud setup: docker enabled"

                  log "opencode-cloud setup: bootstrap config"
                  opencode-cloud --quiet setup --bootstrap
                  log "opencode-cloud setup: bootstrap complete"

                  # Wait briefly for the service to accept HTTP connections.
                  log "opencode-cloud setup: wait for service readiness"
                  for _ in $(seq 1 30); do
                    if curl -sS --max-time 2 http://localhost:3000/ -o /dev/null; then
                      break
                    fi
                    sleep 2
                  done

                  # Fail the stack if the service never becomes reachable.
                  if ! curl -sS --max-time 2 http://localhost:3000/ -o /dev/null; then
                    log "opencode-cloud setup: service not reachable"
                    signal_result 1 "opencode-cloud service did not become reachable on port 3000"
                  fi

                  log "opencode-cloud setup: create user $OPENCODE_USERNAME"
                  user_output="$(opencode-cloud user add "$OPENCODE_USERNAME" --generate)"
                  OPENCODE_PASSWORD="$(printf '%s\n' "$user_output" | sed -n 's/.*Password: //p' | tail -n 1)"
                  if [ -z "$OPENCODE_PASSWORD" ]; then
                    log "opencode-cloud setup: failed to read generated password"
                    signal_result 1 "opencode-cloud failed to read generated password"
                  fi
                  pass_len="$(printf '%s' "$OPENCODE_PASSWORD" | wc -c | tr -d ' ')"
                  printf 'user=%q pass_len=%s\n' "$OPENCODE_USERNAME" "$pass_len"
                  log "opencode-cloud setup: user created"

                  log "opencode-cloud setup: disable unauthenticated network"
                  opencode-cloud config set allow_unauthenticated_network false

                  log "opencode-cloud setup: write secrets payload"
                  secret_payload="$(jq -n \
                    --arg opencode_url "$OPENCODE_DOMAIN_URL" \
                    --arg opencode_alb_url "$OPENCODE_ALB_URL" \
                    --arg cockpit_url "$COCKPIT_DOMAIN_URL" \
                    --arg cockpit_alb_url "$COCKPIT_ALB_URL" \
                    --arg username "$OPENCODE_USERNAME" \
                    --arg password "$OPENCODE_PASSWORD" \
                    --arg container "$OPENCODE_CONTAINER_NAME" \
                    --arg image "$OPENCODE_IMAGE" \
                    '{opencode_url:$opencode_url,opencode_alb_url:$opencode_alb_url,cockpit_url:$cockpit_url,cockpit_alb_url:$cockpit_alb_url,username:$username,password:$password,container:$container,image:$image}')"

                  log "opencode-cloud setup: store secret"
                  aws secretsmanager put-secret-value \
                    --region "$AWS_REGION" \
                    --secret-id "$OPENCODE_CREDENTIALS_SECRET_ARN" \
                    --secret-string "$secret_payload"
                  log "opencode-cloud setup: secret stored"

                  log "opencode-cloud setup: mark provisioned"
                  date -u +"%Y-%m-%dT%H:%M:%SZ" > "$PROVISIONED_FILE"
                  log "opencode-cloud setup: complete"
                  signal_result 0 "opencode-cloud provisioned successfully"
            runcmd:
              - [bash, -lc, "/usr/local/bin/opencode-cloud-setup.sh"]

Outputs:
  OpencodeUrl:
    Description: "Primary opencode URL (requires DNS + ACM validation)."
    Value: !Sub "https://${DomainName}"
  CockpitUrl:
    Description: "Cockpit URL (requires DNS + ACM validation)."
    Value: !Sub "https://${DomainName}/cockpit"
  AlbDnsName:
    Description: "ALB DNS name (useful for debugging before DNS cutover)."
    Value: !GetAtt ApplicationLoadBalancer.DNSName
  CertificateArn:
    Description: "ACM certificate ARN."
    Value: !Ref Certificate
  InstanceId:
    Description: "EC2 instance ID."
    Value: !Ref OpencodeInstance
  VpcId:
    Description: "VPC ID (created or provided)."
    Value: !If [UseExistingVpcCondition, !Ref ExistingVpcId, !Ref Vpc]
  PublicSubnets:
    Description: "Public subnet IDs used by the ALB."
    Value: !If
      - UseExistingVpcCondition
      - !Join [",", !Ref ExistingPublicSubnetIds]
      - !Join [",", [!Ref PublicSubnetA, !Ref PublicSubnetB]]
  PrivateSubnet:
    Description: "Private subnet ID used by the instance."
    Value: !If [UseExistingVpcCondition, !Ref ExistingPrivateSubnetId, !Ref PrivateSubnetA]
  CredentialsSecretArn:
    Description: "Secrets Manager ARN for generated credentials."
    Value: !Ref CredentialsSecret
