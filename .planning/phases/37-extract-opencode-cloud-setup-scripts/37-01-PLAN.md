---
phase: 37-extract-opencode-cloud-setup-scripts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - infra/aws/cloudformation/opencode-cloud-quick.yaml
  - infra/aws/cloud-init/opencode-cloud-quick.yaml
  - scripts/provisioning/opencode-cloud-setup.sh
  - scripts/provisioning/opencode-cloud-setup-cloudformation.sh
  - scripts/provisioning/opencode-cloud-setup-cloud-init.sh
autonomous: true

must_haves:
  truths:
    - "CloudFormation and cloud-init no longer embed the full setup script body"
    - "Provisioning still runs opencode-cloud setup with the same behavior and logging"
    - "Setup logic is reusable outside AWS by using repo scripts"
  key_links:
    - "infra/aws/cloudformation/opencode-cloud-quick.yaml -> /usr/local/bin/opencode-cloud-setup.sh (bootstrap) -> scripts/provisioning/opencode-cloud-setup-cloudformation.sh -> scripts/provisioning/opencode-cloud-setup.sh"
    - "infra/aws/cloud-init/opencode-cloud-quick.yaml -> /usr/local/bin/opencode-cloud-setup.sh (bootstrap) -> scripts/provisioning/opencode-cloud-setup-cloud-init.sh -> scripts/provisioning/opencode-cloud-setup.sh"
  artifacts:
    - path: "scripts/provisioning/opencode-cloud-setup.sh"
      provides: "Shared provisioning logic for opencode-cloud"
      contains: "opencode-cloud setup"
    - path: "infra/aws/cloudformation/opencode-cloud-quick.yaml"
      provides: "CloudFormation bootstrap using shared setup scripts"
      contains: "opencode-cloud-setup"
    - path: "infra/aws/cloud-init/opencode-cloud-quick.yaml"
      provides: "Cloud-init bootstrap using shared setup scripts"
      contains: "opencode-cloud-setup"
---

<objective>
Extract the opencode-cloud setup script bodies out of AWS CloudFormation and cloud-init templates into reusable repo scripts, then update the templates to fetch or reference those scripts so provisioning behavior is preserved while enabling reuse for other cloud providers.

Purpose: Avoid duplication of long inline scripts and make provisioning reusable.
Output: Shared scripts plus AWS templates wired to use them.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@infra/aws/cloudformation/opencode-cloud-quick.yaml
@infra/aws/cloud-init/opencode-cloud-quick.yaml
@scripts/
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit current setup scripts and decide split</name>
  <files>infra/aws/cloudformation/opencode-cloud-quick.yaml, infra/aws/cloud-init/opencode-cloud-quick.yaml</files>
  <action>
Review both inline /usr/local/bin/opencode-cloud-setup.sh bodies and document shared logic vs AWS-specific logic.
Decide on script layout, for example:
- scripts/provisioning/opencode-cloud-setup.sh (shared core)
- scripts/provisioning/opencode-cloud-setup-cloudformation.sh (CloudFormation wrapper/signal)
- scripts/provisioning/opencode-cloud-setup-cloud-init.sh (cloud-init wrapper/status)
Define how the AWS templates will install or fetch these scripts (e.g., curl raw GitHub, or embed minimal bootstrap that copies from repo),
and capture the decision in a short comment block at the top of the shared script (source of truth for script layout + fetch strategy).
  </action>
  <verify>
The split is explicit and explains how to preserve current behavior (env, logging, signals, status files).
  </verify>
  <done>
Script layout and fetch strategy are decided.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create shared provisioning scripts</name>
  <files>scripts/provisioning/opencode-cloud-setup.sh, scripts/provisioning/opencode-cloud-setup-cloudformation.sh, scripts/provisioning/opencode-cloud-setup-cloud-init.sh</files>
  <action>
Move the shared setup logic into a reusable script and create provider-specific wrappers that:
- Load /etc/opencode-cloud/stack.env (when present)
- Preserve logging to /var/log/opencode-cloud-setup.log
- Keep existing safety checks and idempotency (.provisioned)
- For CloudFormation: keep signal behavior and failure reporting
Ensure scripts remain POSIX-friendly bash with set -euo pipefail and clear comments.
Make sure /usr/local/bin/opencode-cloud-setup.sh is executable (chmod +x) and owned by root.
Keep shared logic free of AWS-only dependencies (AWS inputs should be injected via env or wrapper).
  </action>
  <verify>
Scripts are runnable standalone and match existing provisioning steps.
Shared script runs without AWS-only env; AWS-specific behavior is isolated to wrappers.
  </verify>
  <done>
Shared script and wrappers are in repo with permissions expectations documented.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update AWS templates to use repo scripts</name>
  <files>infra/aws/cloudformation/opencode-cloud-quick.yaml, infra/aws/cloud-init/opencode-cloud-quick.yaml</files>
  <action>
Replace inline script bodies with a minimal bootstrap that fetches the repo scripts
and executes the correct wrapper. The bootstrap must:
- define a pinned script base URL (e.g., raw GitHub at a specific tag or commit SHA)
- optionally verify a checksum (sha256) for fetched scripts
- write scripts to /usr/local/bin, chmod +x, then run /usr/local/bin/opencode-cloud-setup.sh
Ensure:
- No setup scripts are committed into the stack outputs.
- /usr/local/bin/opencode-cloud-setup.sh is still the invoked entrypoint
  (but now a small bootstrap wrapper or symlink).
- CloudFormation and cloud-init still write the same env values.
  </action>
  <verify>
Both templates reference the new scripts and do not embed the full body.
  </verify>
  <done>
AWS templates use the shared scripts and provisioning flow is intact.
  </done>
</task>

</tasks>

<verification>
1. CloudFormation template no longer embeds the full setup script body
2. Cloud-init template no longer embeds the full setup script body
3. Provisioning still logs to /var/log/opencode-cloud-setup.log and runs successfully
4. CloudFormation still signals stack success/failure and cloud-init still writes status artifacts
5. /var/lib/opencode-cloud/.provisioned idempotency marker is preserved
6. Environment export (stack.env) still influences provisioning as before
</verification>

<success_criteria>
- Setup logic lives in repo scripts under scripts/provisioning/
- AWS templates fetch/execute shared scripts without regression
- Reusable setup flow is ready for non-AWS providers
</success_criteria>

<output>
After completion, create `.planning/phases/37-extract-opencode-cloud-setup-scripts/37-01-SUMMARY.md`
</output>
