---
phase: 05-interactive-setup-wizard
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - packages/cli-rust/src/commands/config/set.rs
  - packages/cli-rust/src/commands/config/env.rs
  - packages/cli-rust/src/commands/config/mod.rs
  - packages/cli-rust/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "User can set config values via occ config set <key> <value>"
    - "User cannot set password via command argument (security)"
    - "occ config set password prompts interactively"
    - "Warning shown when service running and config changed"
    - "User can manage env vars via occ config env set/list/remove"
    - "All config values are editable (none read-only)"
  artifacts:
    - path: "packages/cli-rust/src/commands/config/set.rs"
      provides: "occ config set implementation"
      contains: "fn cmd_config_set"
    - path: "packages/cli-rust/src/commands/config/env.rs"
      provides: "occ config env subcommands"
      contains: "fn cmd_config_env"
  key_links:
    - from: "packages/cli-rust/src/commands/config/set.rs"
      to: "packages/core/src/config/mod.rs"
      via: "save_config call"
      pattern: "save_config"
    - from: "packages/cli-rust/src/commands/config/set.rs"
      to: "dialoguer::Password"
      via: "interactive password prompt"
      pattern: "Password::new"
---

<objective>
Implement config mutation commands: set for individual values and env for container environment variables.

Purpose: Allow users to modify configuration after initial setup without editing JSON directly.

Output:
- `occ config set <key> <value>` for all config fields
- `occ config set password` prompts interactively (never accepts CLI arg)
- `occ config env set KEY=value` to add/update env vars
- `occ config env list` to show current env vars
- `occ config env remove KEY` to delete env var
- Warning displayed when config changed while service running
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-interactive-setup-wizard/05-CONTEXT.md
@.planning/phases/05-interactive-setup-wizard/05-RESEARCH.md
@.planning/phases/05-interactive-setup-wizard/05-01-SUMMARY.md
@packages/core/src/config/schema.rs
@packages/core/src/config/mod.rs
@packages/cli-rust/src/commands/config/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement config set command</name>
  <files>
    packages/cli-rust/src/commands/config/set.rs
    packages/cli-rust/src/commands/config/mod.rs
  </files>
  <action>
Create `commands/config/set.rs`:

1. Function signature: `pub fn cmd_config_set(key: &str, value: Option<&str>, quiet: bool) -> Result<()>`
   - value is Option because password key should prompt if no value given

2. Special handling for password:
   - If key is "password" or "auth_password":
     - If value is Some, return error: "Password cannot be set via command line for security.\nUse: occ config set password  (will prompt securely)"
     - If value is None, prompt using dialoguer::Password with confirmation
     - Handle Ctrl+C gracefully: catch IoError::Interrupted, show cursor, return "Cancelled"

3. Key mapping (accept both forms):
   - port / opencode_web_port -> set opencode_web_port (parse as u16)
   - bind / hostname -> set bind
   - username / auth_username -> set auth_username (validate: 3-32 chars, alphanumeric + underscore)
   - auto_restart -> set auto_restart (parse as bool: true/false/yes/no/1/0)
   - boot_mode -> set boot_mode (validate: "user" or "system")
   - restart_retries -> set restart_retries (parse as u32)
   - restart_delay -> set restart_delay (parse as u32)

4. For all keys except password: require value, return error if None

5. Load config, modify field, save_config()

6. Check if service is running (use container_is_running from docker module):
   - If running and not quiet, print yellow warning: "Restart required for changes to take effect"

7. If not quiet, print success: "Set {key} = {display_value}"
   - For password, display_value is "********"

Update `commands/config/mod.rs`:
- Add Set subcommand with key: String and value: Option<String>
- Route to cmd_config_set

Username validation rules (from CONTEXT.md):
- Non-empty
- 3-32 characters
- Alphanumeric + underscore only
  </action>
  <verify>
Run `just build` - compiles.
Run `cargo run -p opencode-cloud -- config set port 8080` - sets port, shows success.
Run `cargo run -p opencode-cloud -- config get port` - shows 8080.
Run `cargo run -p opencode-cloud -- config set password mypass` - shows security error.
Run `cargo run -p opencode-cloud -- config set password` - prompts interactively.
  </verify>
  <done>
Config set command works for all keys. Password prompts interactively. Validation works. Warning shown when service running.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement config env subcommands</name>
  <files>
    packages/cli-rust/src/commands/config/env.rs
    packages/cli-rust/src/commands/config/mod.rs
  </files>
  <action>
Create `commands/config/env.rs`:

1. Define EnvCommands enum:
   ```rust
   pub enum EnvCommands {
       Set { env_var: String },  // KEY=value format
       List,
       Remove { key: String },
   }
   ```

2. Implement `pub fn cmd_config_env(cmd: EnvCommands, quiet: bool) -> Result<()>`

3. Set subcommand:
   - Validate env_var contains '=' (error if not: "Format must be KEY=value")
   - Extract key (part before first '=')
   - Load config
   - Remove any existing entry with same key (retain only entries not starting with "KEY=")
   - Add new entry to container_env
   - Save config
   - Print: "Set environment variable: {key}"

4. List subcommand:
   - Load config
   - If container_env is empty, print "(no environment variables configured)"
   - Otherwise print each in format: "  KEY=value" (one per line)
   - At end, print count: "{n} environment variable(s)"

5. Remove subcommand:
   - Load config
   - Check if any entry starts with "{key}="
   - If not found, return error: "Environment variable not found: {key}"
   - Remove matching entry
   - Save config
   - Print: "Removed environment variable: {key}"

Update `commands/config/mod.rs`:
- Add Env subcommand that wraps EnvCommands
- Route to cmd_config_env
  </action>
  <verify>
Run `just build` - compiles.
Run `cargo run -p opencode-cloud -- config env list` - shows "(no environment variables configured)".
Run `cargo run -p opencode-cloud -- config env set FOO=bar` - sets, shows success.
Run `cargo run -p opencode-cloud -- config env list` - shows "  FOO=bar" and count.
Run `cargo run -p opencode-cloud -- config env remove FOO` - removes, shows success.
Run `cargo run -p opencode-cloud -- config env remove NONEXISTENT` - shows error.
  </verify>
  <done>
Config env subcommands work. Set adds/updates, list shows all, remove deletes. Format validation works.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire env subcommands and verify full config command tree</name>
  <files>
    packages/cli-rust/src/lib.rs
    packages/cli-rust/src/commands/config/mod.rs
  </files>
  <action>
Ensure the full config command tree is properly wired in lib.rs and mod.rs:

1. In config/mod.rs, the ConfigCommands enum should have:
   ```rust
   #[derive(Subcommand)]
   pub enum ConfigCommands {
       /// Show current configuration
       Show {
           #[arg(long)]
           json: bool,
       },
       /// Get a configuration value
       Get {
           key: String,
       },
       /// Set a configuration value
       Set {
           key: String,
           value: Option<String>,
       },
       /// Reset configuration to defaults
       Reset {
           #[arg(long)]
           force: bool,
       },
       /// Manage container environment variables
       #[command(subcommand)]
       Env(EnvCommands),
   }
   ```

2. The cmd_config function should route all subcommands:
   ```rust
   pub fn cmd_config(cmd: ConfigCommands, config: &Config, quiet: bool) -> Result<()> {
       match cmd {
           ConfigCommands::Show { json } => cmd_config_show(config, json, quiet),
           ConfigCommands::Get { key } => cmd_config_get(&key, config),
           ConfigCommands::Set { key, value } => cmd_config_set(&key, value.as_deref(), quiet),
           ConfigCommands::Reset { force } => cmd_config_reset(force, quiet),
           ConfigCommands::Env(env_cmd) => cmd_config_env(env_cmd, quiet),
       }
   }
   ```

3. Verify lib.rs routing is correct (should already be done in 05-01).

4. Run full command tree test to verify all paths work.
  </action>
  <verify>
Run `just test` - all tests pass.
Run `cargo run -p opencode-cloud -- config --help` - shows all subcommands.
Run `cargo run -p opencode-cloud -- config env --help` - shows env subcommands.
Full command verification:
- `occ config` - table output
- `occ config show` - same
- `occ config show --json` - JSON output
- `occ config get port` - single value
- `occ config set port 3001` - sets value
- `occ config reset --force` - resets
- `occ config env list` - lists env vars
- `occ config env set TEST=value` - sets env var
- `occ config env remove TEST` - removes env var
  </verify>
  <done>
Full config command tree is wired and working. All subcommands accessible. Help text displays correctly.
  </done>
</task>

</tasks>

<verification>
1. Config set:
   - `occ config set port 8080` works
   - `occ config set password secret` returns security error
   - `occ config set password` prompts interactively
   - `occ config set username bob` validates (3-32 chars, alphanumeric+underscore)
   - `occ config set boot_mode invalid` returns validation error

2. Config env:
   - `occ config env set FOO=bar` adds env var
   - `occ config env set FOO=baz` updates (replaces) env var
   - `occ config env list` shows all with count
   - `occ config env remove FOO` removes
   - `occ config env remove UNKNOWN` returns not found error

3. Service running warning:
   - Start service with `occ start`
   - Run `occ config set port 9000`
   - See yellow warning about restart required

4. All commands in tree:
   - `occ config --help` shows Show, Get, Set, Reset, Env
   - `occ config env --help` shows Set, List, Remove
</verification>

<success_criteria>
- `occ config set <key> <value>` works for all config keys
- Password cannot be set via command argument
- `occ config set password` prompts interactively with confirmation
- Username validation enforced (3-32 chars, alphanumeric+underscore)
- `occ config env set/list/remove` commands work
- Warning shown when config changed while service running
- All tests pass (`just test`)
</success_criteria>

<output>
After completion, create `.planning/phases/05-interactive-setup-wizard/05-02-SUMMARY.md`
</output>
