---
phase: 05-interactive-setup-wizard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/config/schema.rs
  - packages/core/Cargo.toml
  - packages/cli-rust/src/lib.rs
  - packages/cli-rust/src/commands/config/mod.rs
  - packages/cli-rust/src/commands/config/show.rs
  - packages/cli-rust/src/commands/config/get.rs
  - packages/cli-rust/src/commands/config/reset.rs
  - packages/cli-rust/src/commands/mod.rs
  - packages/cli-rust/Cargo.toml
autonomous: true

must_haves:
  truths:
    - "User can view current config via occ config (table format)"
    - "User can view config in JSON format via occ config --json"
    - "User can get single config value via occ config get <key>"
    - "User can reset config to defaults via occ config reset"
    - "Config file location is shown in config output"
    - "Passwords are masked in config display"
  artifacts:
    - path: "packages/core/src/config/schema.rs"
      provides: "Config struct with auth_username, auth_password, container_env fields"
      contains: "auth_username"
    - path: "packages/cli-rust/src/commands/config/mod.rs"
      provides: "Config subcommand router"
      exports: ["ConfigCommands", "cmd_config"]
    - path: "packages/cli-rust/src/commands/config/show.rs"
      provides: "occ config implementation with table output"
      contains: "comfy_table"
    - path: "packages/cli-rust/src/commands/config/get.rs"
      provides: "occ config get <key> implementation"
      contains: "fn cmd_config_get"
    - path: "packages/cli-rust/src/commands/config/reset.rs"
      provides: "occ config reset implementation"
      contains: "fn cmd_config_reset"
  key_links:
    - from: "packages/cli-rust/src/lib.rs"
      to: "packages/cli-rust/src/commands/config/mod.rs"
      via: "Commands::Config routing"
      pattern: "Config\\(.*ConfigCommands"
    - from: "packages/cli-rust/src/commands/config/show.rs"
      to: "packages/core/src/config/schema.rs"
      via: "Config struct access"
      pattern: "Config"
---

<objective>
Extend config schema with auth credentials and container environment variables, and implement read-only config commands.

Purpose: Establish the foundation for the setup wizard by adding required config fields and providing users with config inspection capabilities.

Output:
- Extended Config struct with auth_username, auth_password, container_env fields
- `occ config` command with table output (passwords masked)
- `occ config --json` for scripting
- `occ config get <key>` for single value retrieval
- `occ config reset` with confirmation prompt
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-interactive-setup-wizard/05-CONTEXT.md
@.planning/phases/05-interactive-setup-wizard/05-RESEARCH.md
@packages/core/src/config/schema.rs
@packages/core/src/config/mod.rs
@packages/cli-rust/src/lib.rs
@packages/cli-rust/src/commands/mod.rs
@packages/cli-rust/Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend config schema with auth and env fields</name>
  <files>
    packages/core/src/config/schema.rs
  </files>
  <action>
Add three new fields to the Config struct:

1. `auth_username: Option<String>` - Username for opencode basic auth
   - Default: None (triggers wizard on first run)
   - Serde default to None

2. `auth_password: Option<String>` - Password for opencode basic auth
   - Default: None (triggers wizard on first run)
   - Serde default to None

3. `container_env: Vec<String>` - Environment variables passed to container
   - Default: empty vec
   - Format: ["KEY=value", "KEY2=value2"]
   - Serde default to empty vec

Add helper method `Config::has_required_auth()` that returns true if both auth_username and auth_password are Some and non-empty.

Update existing tests to include new fields. Add tests for:
- Default values (None/empty)
- Serialization/deserialization roundtrip with new fields
- has_required_auth() returns false when either is None or empty
- has_required_auth() returns true when both are set

IMPORTANT: All new fields must have `#[serde(default)]` to maintain backward compatibility with existing config files (deny_unknown_fields is set, but default handles missing fields).
  </action>
  <verify>
Run `just test` - all tests pass including new schema tests.
  </verify>
  <done>
Config struct has auth_username, auth_password, container_env fields with proper defaults. has_required_auth() helper exists and works correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create config subcommand module with show, get, reset</name>
  <files>
    packages/cli-rust/src/commands/config/mod.rs
    packages/cli-rust/src/commands/config/show.rs
    packages/cli-rust/src/commands/config/get.rs
    packages/cli-rust/src/commands/config/reset.rs
    packages/cli-rust/src/commands/mod.rs
    packages/cli-rust/Cargo.toml
  </files>
  <action>
1. Add comfy-table to cli-rust Cargo.toml dependencies:
   ```toml
   comfy-table = "7"
   ```

2. Create `commands/config/mod.rs`:
   - Define ConfigCommands enum with subcommands: Show, Get, Reset
   - Show: `--json` flag for JSON output
   - Get: takes `key: String` argument
   - Reset: `--force` flag to skip confirmation
   - Export cmd_config function that routes to subcommand handlers

3. Create `commands/config/show.rs`:
   - Use comfy-table for formatted output
   - Table columns: Key, Value
   - Mask password field: show "********" if set, "(not set)" if None
   - Show username as-is or "(not set)" if None
   - Show container_env as comma-separated list or "(none)" if empty
   - At end of output, show: "Config file: {path}"
   - If `--json` flag, output serde_json::to_string_pretty instead of table

4. Create `commands/config/get.rs`:
   - Accept key parameter (supports both flat and dotted: "port" or "opencode_web_port")
   - Output just the value (no formatting) for scripting
   - For password key: output "********" (never reveal actual password)
   - Return error for unknown keys with helpful message listing valid keys

5. Create `commands/config/reset.rs`:
   - Use dialoguer::Confirm to ask "Reset configuration to defaults? This cannot be undone."
   - Default to false (user must explicitly confirm)
   - If `--force` flag, skip confirmation
   - Create new Config::default() and save_config()
   - Show "Configuration reset to defaults" on success

6. Update `commands/mod.rs`:
   - Add `mod config;`
   - Add `pub use config::{ConfigCommands, cmd_config};`

Key mappings for get command (support both forms):
- port / opencode_web_port -> opencode_web_port
- bind / hostname -> bind
- username / auth_username -> auth_username
- password / auth_password -> auth_password (masked)
- env / container_env -> container_env (as JSON array)
- auto_restart -> auto_restart
- boot_mode -> boot_mode
- restart_retries -> restart_retries
- restart_delay -> restart_delay
  </action>
  <verify>
Run `just build` - compiles without errors.
Run `just test` - passes.
Run `cargo run -p opencode-cloud -- config` - shows table output.
Run `cargo run -p opencode-cloud -- config --json` - shows JSON output.
Run `cargo run -p opencode-cloud -- config get port` - shows port value.
  </verify>
  <done>
Config subcommands (show, get, reset) are implemented. Table output works with masked passwords. JSON output works. Get returns single values. Reset prompts for confirmation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire config commands into CLI and replace placeholder</name>
  <files>
    packages/cli-rust/src/lib.rs
  </files>
  <action>
Replace the existing ConfigCommands enum and handle_config function with the new implementation:

1. Remove the existing ConfigCommands enum definition (lines ~57-68)
2. Remove the existing handle_config function (lines ~257-286)
3. Import the new config module: add to Commands enum `Config(commands::ConfigCommands)`
4. Update the match arm for Config to call `commands::cmd_config(cmd, &config, cli.quiet)`

The Commands enum should have:
```rust
/// Manage configuration
Config(commands::ConfigCommands),
```

The match arm should be:
```rust
Some(Commands::Config(cmd)) => commands::cmd_config(cmd, &config, cli.quiet),
```

Make sure cmd_config signature in config/mod.rs accepts (ConfigCommands, &Config, bool) and returns Result<()>.
  </action>
  <verify>
Run `just build` - compiles without errors.
Run `just test` - passes.
Run `cargo run -p opencode-cloud -- config` - shows table output (not the old JSON placeholder).
Run `cargo run -p opencode-cloud -- config show` - same as above.
Run `cargo run -p opencode-cloud -- config get port` - shows 3000.
Run `cargo run -p opencode-cloud -- config reset --force` - resets config.
  </verify>
  <done>
CLI routes to new config subcommands. Old placeholder removed. All config subcommands accessible via `occ config [show|get|reset]`.
  </done>
</task>

</tasks>

<verification>
1. Schema validation:
   - `just test` passes with new schema fields
   - Existing config files still load (backward compatible)

2. Config show:
   - `occ config` displays table with all fields
   - Password shown as "********" when set
   - Config file path shown at bottom

3. Config get:
   - `occ config get port` returns just "3000"
   - `occ config get password` returns "********" (never actual value)
   - `occ config get unknown` returns helpful error

4. Config reset:
   - `occ config reset` prompts for confirmation
   - `occ config reset --force` skips prompt
   - After reset, config has default values

5. JSON output:
   - `occ config --json` outputs valid JSON
   - JSON contains all fields including new ones
</verification>

<success_criteria>
- Config struct has auth_username, auth_password, container_env fields
- `occ config` shows table with masked passwords
- `occ config --json` outputs JSON
- `occ config get <key>` returns single values
- `occ config reset` works with confirmation
- All tests pass (`just test`)
- Backward compatible with existing config files
</success_criteria>

<output>
After completion, create `.planning/phases/05-interactive-setup-wizard/05-01-SUMMARY.md`
</output>
