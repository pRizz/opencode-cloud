---
phase: 05-interactive-setup-wizard
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - packages/cli-rust/src/wizard/mod.rs
  - packages/cli-rust/src/wizard/auth.rs
  - packages/cli-rust/src/wizard/network.rs
  - packages/cli-rust/src/wizard/summary.rs
  - packages/cli-rust/src/wizard/prechecks.rs
  - packages/cli-rust/src/commands/setup.rs
  - packages/cli-rust/src/commands/mod.rs
  - packages/cli-rust/src/lib.rs
  - packages/cli-rust/Cargo.toml
autonomous: true

must_haves:
  truths:
    - "Wizard launches automatically when auth credentials missing"
    - "User can run wizard manually via occ setup"
    - "Wizard prompts for username and password with validation"
    - "User can choose random credentials or enter their own"
    - "Wizard prompts for port and hostname with defaults"
    - "Quick setup mode skips most prompts"
    - "Wizard shows summary before saving"
    - "Ctrl+C cancels wizard without saving partial config"
    - "Docker availability checked before wizard starts"
  artifacts:
    - path: "packages/cli-rust/src/wizard/mod.rs"
      provides: "Wizard state machine and runner"
      contains: "WizardState"
    - path: "packages/cli-rust/src/wizard/auth.rs"
      provides: "Auth credential prompts"
      contains: "prompt_auth"
    - path: "packages/cli-rust/src/wizard/network.rs"
      provides: "Port and hostname prompts"
      contains: "prompt_port"
    - path: "packages/cli-rust/src/wizard/summary.rs"
      provides: "Final summary display"
      contains: "display_summary"
    - path: "packages/cli-rust/src/commands/setup.rs"
      provides: "occ setup command"
      contains: "cmd_setup"
  key_links:
    - from: "packages/cli-rust/src/lib.rs"
      to: "packages/cli-rust/src/wizard/mod.rs"
      via: "auto-trigger check in run()"
      pattern: "has_required_auth.*wizard"
    - from: "packages/cli-rust/src/wizard/mod.rs"
      to: "packages/core/src/config/mod.rs"
      via: "save_config at end"
      pattern: "save_config"
    - from: "packages/cli-rust/src/commands/setup.rs"
      to: "packages/cli-rust/src/wizard/mod.rs"
      via: "run_wizard call"
      pattern: "run_wizard"
---

<objective>
Implement the interactive setup wizard for first-time configuration.

Purpose: Provide a guided experience for new users to configure credentials and basic settings without editing JSON.

Output:
- `occ setup` command to run/rerun wizard
- Auto-trigger when required auth missing
- Credential prompts with random generation option
- Port and hostname prompts with defaults
- Quick setup mode for experienced users
- Summary display before saving
- Proper Ctrl+C handling without partial saves
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-interactive-setup-wizard/05-CONTEXT.md
@.planning/phases/05-interactive-setup-wizard/05-RESEARCH.md
@.planning/phases/05-interactive-setup-wizard/05-01-SUMMARY.md
@.planning/phases/05-interactive-setup-wizard/05-02-SUMMARY.md
@packages/core/src/config/schema.rs
@packages/core/src/config/mod.rs
@packages/cli-rust/src/lib.rs
@packages/cli-rust/src/commands/mod.rs
@packages/cli-rust/src/commands/start.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create wizard module with state machine and prechecks</name>
  <files>
    packages/cli-rust/src/wizard/mod.rs
    packages/cli-rust/src/wizard/prechecks.rs
    packages/cli-rust/Cargo.toml
  </files>
  <action>
1. Add rand to cli-rust Cargo.toml:
   ```toml
   rand = "0.9"
   ```

2. Create `wizard/mod.rs`:
   - Define WizardState struct to hold collected values:
     ```rust
     pub struct WizardState {
         pub auth_username: Option<String>,
         pub auth_password: Option<String>,
         pub port: u16,
         pub bind: String,
     }
     ```
   - Implement WizardState::apply_to_config(&self, config: &mut Config) to copy values
   - Export run_wizard function: `pub async fn run_wizard(existing_config: Option<&Config>) -> Result<Config>`
   - run_wizard coordinates the flow:
     1. Run prechecks (Docker, TTY)
     2. Offer quick setup mode
     3. If quick: prompt auth only, use defaults for rest
     4. If full: prompt auth, port, hostname
     5. Display summary
     6. Ask to save
     7. Return completed Config (does NOT save - caller saves)

3. Create `wizard/prechecks.rs`:
   - `pub async fn verify_docker_available() -> Result<()>`
     - Use DockerClient::new() and verify_connection()
     - On failure, return actionable error: "Docker is not available.\n\nPlease start Docker Desktop or the Docker daemon before running setup."
   - `pub fn verify_tty() -> Result<()>`
     - Use std::io::stdin().is_terminal() (std::io::IsTerminal trait)
     - On failure: "No TTY detected. Use occ config set or provide config file.\nFor non-interactive setup, pre-set auth credentials then run commands."

4. Export all submodules: mod auth; mod network; mod summary; mod prechecks;

Handle Ctrl+C throughout wizard:
- Wrap all dialoguer calls in match on Result
- On IoError::Interrupted, restore cursor and return Err(anyhow!("Setup cancelled"))
- Use console::Term::stdout().show_cursor() for terminal cleanup
  </action>
  <verify>
Run `just build` - compiles (auth/network/summary can be stub functions initially).
  </verify>
  <done>
Wizard module structure created. WizardState defined. Prechecks implemented. Ctrl+C handling pattern established.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement auth and network prompts</name>
  <files>
    packages/cli-rust/src/wizard/auth.rs
    packages/cli-rust/src/wizard/network.rs
  </files>
  <action>
1. Create `wizard/auth.rs`:

   - `pub fn prompt_auth(step: usize, total: usize) -> Result<(String, String)>`
   - Show step counter: "[{step}/{total}] Authentication"
   - First ask with Select: "How would you like to set credentials?"
     - Option 1: "Generate secure random credentials"
     - Option 2: "Enter my own username and password"

   For random generation:
   - Generate username: "admin" (fixed, simple)
   - Generate password: 24 random alphanumeric chars using rand
     ```rust
     use rand::Rng;
     use rand::distr::Alphanumeric;
     let password: String = rand::rng()
         .sample_iter(Alphanumeric)
         .take(24)
         .map(char::from)
         .collect();
     ```
   - Display: "Generated credentials:\n  Username: admin\n  Password: {password}\n\nSave these credentials securely - the password won't be shown again."
   - Ask Confirm: "Use these credentials?"
   - If no, loop back to selection

   For manual entry:
   - Prompt username with Input:
     - Default: none
     - Validation: 3-32 chars, alphanumeric + underscore
     - Error message: "Username must be 3-32 characters (letters, numbers, underscore)"
   - Prompt password with Password:
     - with_confirmation("Confirm password", "Passwords do not match")
     - No validation (any non-empty accepted per CONTEXT.md)
   - Return (username, password)

2. Create `wizard/network.rs`:

   - `pub fn prompt_port(step: usize, total: usize, default_port: u16) -> Result<u16>`
   - Show step counter: "[{step}/{total}] Port Configuration"
   - Show explanation: "Port for the opencode web UI"
   - Use Input with default value
   - Validation: parse as u16, 1-65535
   - If port < 1024, show warning (but still accept): "Note: Ports below 1024 may require elevated privileges"
   - Check port availability using check_port_available from start.rs (import or duplicate)
   - If port in use, suggest next available and ask to use that instead

   - `pub fn prompt_hostname(step: usize, total: usize, default_bind: &str) -> Result<String>`
   - Show step counter: "[{step}/{total}] Network Binding"
   - Show explanation:
     ```
     Network binding address:
       localhost  - Accessible only from this machine (recommended)
       0.0.0.0    - Accessible from network (requires firewall/auth)
     ```
   - Use Select with options: "localhost (local only)", "0.0.0.0 (network accessible)"
   - If 0.0.0.0 selected, show yellow warning: "Warning: Network exposure enabled. Ensure firewall rules and authentication are configured."
   - Return "localhost" or "0.0.0.0"
  </action>
  <verify>
Run `just build` - compiles.
Manual test: create a test binary or temporarily call prompt_auth/prompt_port/prompt_hostname to verify UI.
  </verify>
  <done>
Auth prompts work with random generation and manual entry. Network prompts work with port validation and hostname selection. Warnings display correctly.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement summary display and setup command</name>
  <files>
    packages/cli-rust/src/wizard/summary.rs
    packages/cli-rust/src/wizard/mod.rs
    packages/cli-rust/src/commands/setup.rs
    packages/cli-rust/src/commands/mod.rs
    packages/cli-rust/src/lib.rs
  </files>
  <action>
1. Create `wizard/summary.rs`:
   - `pub fn display_summary(state: &WizardState)` - no Result, just prints
   - Use comfy-table for formatted output:
     ```
     Configuration Summary
     ---------------------
     Username:  {username}
     Password:  ********
     Port:      {port}
     Binding:   {bind}
     ```
   - After table, show config file location: "Config will be saved to: {path}"

2. Complete `wizard/mod.rs` run_wizard implementation:
   ```rust
   pub async fn run_wizard(existing_config: Option<&Config>) -> Result<Config> {
       // 1. Prechecks
       verify_tty()?;
       verify_docker_available().await?;

       // 2. If existing config, show current summary and ask to reconfigure
       if let Some(config) = existing_config {
           if config.has_required_auth() {
               println!("Current configuration:");
               // Show current values...
               let reconfigure = Confirm::new()
                   .with_prompt("Reconfigure?")
                   .default(false)
                   .interact()?;
               if !reconfigure {
                   return Err(anyhow!("Setup cancelled"));
               }
           }
       }

       // 3. Quick setup offer
       let total_steps = 3; // auth, port, hostname
       let quick = Confirm::new()
           .with_prompt("Use defaults for everything except credentials?")
           .default(false)
           .interact()?;

       // 4. Collect values
       let (username, password) = prompt_auth(1, if quick { 1 } else { total_steps })?;

       let (port, bind) = if quick {
           (3000, "localhost".to_string())
       } else {
           let port = prompt_port(2, total_steps, 3000)?;
           let bind = prompt_hostname(3, total_steps, "localhost")?;
           (port, bind)
       };

       let state = WizardState {
           auth_username: Some(username),
           auth_password: Some(password),
           port,
           bind,
       };

       // 5. Summary
       println!();
       display_summary(&state);
       println!();

       // 6. Confirm save
       let save = Confirm::new()
           .with_prompt("Save this configuration?")
           .default(true)
           .interact()?;

       if !save {
           return Err(anyhow!("Setup cancelled"));
       }

       // 7. Build and return config
       let mut config = existing_config.cloned().unwrap_or_default();
       state.apply_to_config(&mut config);
       Ok(config)
   }
   ```

3. Create `commands/setup.rs`:
   - SetupArgs: `--yes` flag for non-interactive (requires pre-set auth)
   - `pub async fn cmd_setup(args: &SetupArgs, quiet: bool) -> Result<()>`
   - If --yes flag:
     - Load config
     - If !has_required_auth(), return error: "Non-interactive mode requires auth credentials to be pre-set.\nUse: occ config set username <user> && occ config set password"
     - Skip wizard, just print "Configuration already set"
   - Otherwise:
     - Load existing config (or None if file doesn't exist)
     - Run wizard
     - save_config()
     - Print success message
     - Ask: "Start opencode-cloud now? [Y/n]"
     - If yes, call cmd_start equivalent

4. Update `commands/mod.rs`:
   - Add mod setup;
   - Add pub use setup::{SetupArgs, cmd_setup};

5. Update `lib.rs`:
   - Add Setup command to Commands enum
   - Add match arm for Setup -> cmd_setup
   - Add auto-trigger logic BEFORE command matching:
     ```rust
     // Check if wizard needed (missing auth and not running setup/config command)
     let needs_wizard = !config.has_required_auth() &&
         !matches!(cli.command, Some(Commands::Setup(_)) | Some(Commands::Config(_)));

     if needs_wizard {
         eprintln!("First-time setup required. Running wizard...\n");
         let rt = tokio::runtime::Runtime::new()?;
         let new_config = rt.block_on(wizard::run_wizard(Some(&config)))?;
         save_config(&new_config)?;
         eprintln!("\nSetup complete! Run your command again, or use 'occ start' to begin.");
         return Ok(());
     }
     ```
  </action>
  <verify>
Run `just build` - compiles.
Run `just test` - passes.

Manual testing:
1. Delete config file, run `occ status` - wizard auto-triggers
2. Complete wizard - config saved
3. Run `occ setup` - shows current config, asks to reconfigure
4. Run `occ setup` and complete - asks to start service
5. Test Ctrl+C at any point - exits cleanly without partial save
  </verify>
  <done>
Wizard complete. Auto-triggers on missing auth. Summary displays before save. Setup command works. Start prompt after wizard.
  </done>
</task>

</tasks>

<verification>
1. Auto-trigger:
   - Delete config or remove auth fields
   - Run any command (e.g., `occ status`)
   - Wizard launches automatically
   - After completing wizard, command works

2. Manual setup:
   - `occ setup` runs wizard
   - If config exists with auth, asks "Reconfigure?"
   - `occ setup --yes` skips wizard if auth pre-set

3. Wizard flow:
   - Quick setup mode: only auth prompts, then summary
   - Full setup: auth, port, hostname prompts
   - Summary shows all values with masked password
   - Confirm before saving

4. Credential options:
   - Random generation shows credentials once
   - Manual entry validates username, requires password confirmation

5. Network prompts:
   - Port validation (1-65535, warns <1024)
   - Port availability check with suggestion
   - Hostname selection with 0.0.0.0 warning

6. Ctrl+C handling:
   - Cancel at any prompt - exits cleanly
   - No partial config saved
   - Terminal cursor restored

7. Start prompt:
   - After wizard completes, asks to start service
   - If yes, starts container
</verification>

<success_criteria>
- Wizard auto-triggers when auth missing
- `occ setup` runs wizard manually
- Random credential generation works
- Manual credential entry with validation works
- Port and hostname prompts work with defaults
- Quick setup mode skips non-auth prompts
- Summary displays before saving
- Ctrl+C cancels cleanly at any point
- Start prompt after wizard completion
- All tests pass (`just test`)
</success_criteria>

<output>
After completion, create `.planning/phases/05-interactive-setup-wizard/05-03-SUMMARY.md`
</output>
