---
phase: 03-service-lifecycle-commands
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/cli-rust/Cargo.toml
  - packages/cli-rust/src/lib.rs
  - packages/cli-rust/src/commands/mod.rs
  - packages/cli-rust/src/commands/start.rs
  - packages/cli-rust/src/commands/stop.rs
  - packages/cli-rust/src/commands/restart.rs
  - packages/cli-rust/src/output/mod.rs
  - packages/cli-rust/src/output/spinner.rs
  - Cargo.toml
autonomous: true

must_haves:
  truths:
    - "User can start service via `occ start` with spinner feedback"
    - "User can stop service via `occ stop` with graceful 30s timeout"
    - "User can restart service via `occ restart`"
    - "Commands are idempotent (start when running shows status and exits 0)"
    - "Quiet mode (-q) suppresses spinners, outputs URL only on start"
    - "Auto-builds image if not found (no prompt)"
  artifacts:
    - path: "packages/cli-rust/src/commands/mod.rs"
      provides: "Command module exports"
    - path: "packages/cli-rust/src/commands/start.rs"
      provides: "Start command with spinner, port check, auto-build"
      min_lines: 100
    - path: "packages/cli-rust/src/commands/stop.rs"
      provides: "Stop command with 30s graceful timeout"
      min_lines: 40
    - path: "packages/cli-rust/src/commands/restart.rs"
      provides: "Restart command (stop + start)"
      min_lines: 30
    - path: "packages/cli-rust/src/output/spinner.rs"
      provides: "CommandSpinner with elapsed time"
      min_lines: 50
  key_links:
    - from: "packages/cli-rust/src/lib.rs"
      to: "commands::start::cmd_start"
      via: "match on Commands::Start"
      pattern: "Commands::Start.*=>.*cmd_start"
    - from: "packages/cli-rust/src/commands/start.rs"
      to: "opencode_cloud_core::docker"
      via: "setup_and_start, build_image"
      pattern: "setup_and_start|build_image"
---

<objective>
Implement start, stop, and restart CLI commands with spinner feedback

Purpose: Enables users to control the opencode service lifecycle through intuitive commands. This is the primary user interface for managing the containerized service.

Output: Three working commands (`occ start`, `occ stop`, `occ restart`) with proper spinner/elapsed time UI, idempotent behavior, and actionable error messages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-service-lifecycle-commands/03-CONTEXT.md
@.planning/phases/03-service-lifecycle-commands/03-RESEARCH.md
@.planning/phases/02-docker-integration/02-03-SUMMARY.md

# Key existing files
@packages/cli-rust/src/lib.rs
@packages/core/src/docker/mod.rs
@packages/core/src/docker/container.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dependencies and create output module with CommandSpinner</name>
  <files>
    - Cargo.toml (workspace)
    - packages/cli-rust/Cargo.toml
    - packages/cli-rust/src/output/mod.rs
    - packages/cli-rust/src/output/spinner.rs
  </files>
  <action>
1. Add new workspace dependencies to root Cargo.toml:
   - `webbrowser = "1.0"` (for --open flag)
   - `humantime = "2.1"` (for duration formatting in status - used later but add now)

2. Add dependencies to packages/cli-rust/Cargo.toml:
   - `indicatif.workspace = true`
   - `tokio.workspace = true`
   - `webbrowser = "1.0"`
   - `humantime = "2.1"`
   - `futures-util.workspace = true`

3. Create packages/cli-rust/src/output/mod.rs:
   - Export `spinner` module
   - Re-export `CommandSpinner`

4. Create packages/cli-rust/src/output/spinner.rs with CommandSpinner struct:
   - Uses indicatif ProgressBar with spinner style
   - Template: `"{spinner:.green} {msg} ({elapsed})"`
   - Tick chars: `"⠋⠙⠹⠸⠼⠴⠦⠧⠇⠏"`
   - `new(message: &str)` - creates spinner with initial message, starts ticking
   - `update(&self, message: &str)` - updates spinner message
   - `success(self, message: &str)` - finishes with green checkmark prefix
   - `fail(self, message: &str)` - finishes with red X prefix
   - Add `quiet: bool` field - if true, all methods are no-ops
   - `new_maybe(message: &str, quiet: bool)` - convenience constructor

Use console::style for checkmark/X coloring. Spinner should enable_steady_tick at 100ms interval.
  </action>
  <verify>
    - `cargo check -p opencode-cloud` passes
    - `cargo test -p opencode-cloud` passes
  </verify>
  <done>Output module exists with working CommandSpinner that respects quiet mode</done>
</task>

<task type="auto">
  <name>Task 2: Implement start, stop, restart commands</name>
  <files>
    - packages/cli-rust/src/commands/mod.rs
    - packages/cli-rust/src/commands/start.rs
    - packages/cli-rust/src/commands/stop.rs
    - packages/cli-rust/src/commands/restart.rs
  </files>
  <action>
1. Create packages/cli-rust/src/commands/mod.rs:
   - Declare submodules: start, stop, restart
   - Re-export: `cmd_start`, `cmd_stop`, `cmd_restart`
   - Re-export args structs: `StartArgs`, `StopArgs`, `RestartArgs`

2. Create packages/cli-rust/src/commands/start.rs:
   - `StartArgs` struct with clap derive:
     - `--port` / `-p`: Optional u16, override config port
     - `--open`: bool flag, open browser after start
   - `cmd_start(args: &StartArgs, quiet: bool, verbose: u8)` async function:
     a. Connect to Docker (DockerClient::connect().await), handle errors with actionable messages
     b. Check if container already running - if so, show status message and exit 0 (idempotent)
     c. Pre-check port availability using `TcpListener::bind(("127.0.0.1", port))`:
        - If port in use, find next available (port+1 to port+100)
        - Return error with suggestion: "Port X in use. Try: occ start --port Y"
     d. Create spinner (unless quiet): "Starting service..."
     e. Check if image exists - if not, update spinner "Building image (first run)..." and call `build_image()`
     f. Update spinner "Starting container..."
     g. Call `setup_and_start(client, Some(port), None)`
     h. On error: spinner.fail(), if container exists show last 20 log lines (fetch via bollard logs API), return error
     i. On success: spinner.success("Service started")
     j. Print result:
        - Quiet mode: just print URL
        - Normal mode: print URL, container ID (first 12 chars), port mapping
     k. If --open flag or config.auto_open (default false), call `webbrowser::open(&url)`
   - Use `anyhow::Result` for error handling
   - Import from opencode_cloud_core::docker: DockerClient, setup_and_start, build_image, image_exists, DOCKERFILE, IMAGE_TAG_DEFAULT, container_is_running, CONTAINER_NAME, DEFAULT_PORT

3. Create packages/cli-rust/src/commands/stop.rs:
   - `StopArgs` struct (empty for now, placeholder for future --remove flag)
   - `cmd_stop(args: &StopArgs, quiet: bool)` async function:
     a. Connect to Docker
     b. Check if container running - if not, show "Service is already stopped" and exit 0 (idempotent)
     c. Create spinner (unless quiet): "Stopping service..."
     d. Update spinner: "Stopping service (30s timeout)..."
     e. Call `stop_service(client, false)` (don't remove container)
     f. spinner.success("Service stopped") or spinner.fail() on error
   - Use 30 second timeout (pass to stop_container if needed, though stop_service uses the default)

4. Create packages/cli-rust/src/commands/restart.rs:
   - `RestartArgs` struct (empty for now)
   - `cmd_restart(args: &RestartArgs, quiet: bool, verbose: u8)` async function:
     a. Connect to Docker
     b. Create spinner (unless quiet): "Restarting service..."
     c. If container running, stop it (update spinner "Stopping...")
     d. Start it (update spinner "Starting...")
     e. spinner.success("Service restarted")
   - Reuse logic from stop/start but with single spinner for UX continuity

All commands should:
- Use `tokio::runtime::Runtime` to run async code (create runtime in each command)
- Format Docker errors with actionable guidance (use helper function)
- Output errors to stderr, normal output to stdout
  </action>
  <verify>
    - `cargo check -p opencode-cloud` passes
    - `cargo test -p opencode-cloud` passes (unit tests if any)
  </verify>
  <done>Three command modules exist with proper async implementation</done>
</task>

<task type="auto">
  <name>Task 3: Wire commands into CLI and add integration</name>
  <files>
    - packages/cli-rust/src/lib.rs
  </files>
  <action>
1. Update packages/cli-rust/src/lib.rs:
   - Add `mod commands;` and `mod output;` declarations
   - Import command args and functions from commands module
   - Add to Commands enum:
     ```rust
     /// Start the opencode service
     Start(commands::StartArgs),
     /// Stop the opencode service
     Stop(commands::StopArgs),
     /// Restart the opencode service
     Restart(commands::RestartArgs),
     ```
   - Update match in run() to handle new commands:
     ```rust
     Some(Commands::Start(args)) => {
         let rt = tokio::runtime::Runtime::new()?;
         rt.block_on(commands::cmd_start(&args, cli.quiet, cli.verbose))
     }
     Some(Commands::Stop(args)) => {
         let rt = tokio::runtime::Runtime::new()?;
         rt.block_on(commands::cmd_stop(&args, cli.quiet))
     }
     Some(Commands::Restart(args)) => {
         let rt = tokio::runtime::Runtime::new()?;
         rt.block_on(commands::cmd_restart(&args, cli.quiet, cli.verbose))
     }
     ```

2. Test CLI help output:
   - `cargo run -p opencode-cloud -- --help` should show start, stop, restart commands
   - `cargo run -p opencode-cloud -- start --help` should show --port and --open flags

3. Verify the commands compile and basic structure is correct.
  </action>
  <verify>
    - `just fmt && just lint && just test && just build` all pass
    - `cargo run -p opencode-cloud -- --help` shows Start, Stop, Restart commands
    - `cargo run -p opencode-cloud -- start --help` shows --port and --open flags
  </verify>
  <done>All three lifecycle commands are wired into CLI and accessible via --help</done>
</task>

</tasks>

<verification>
Phase verification (run after all tasks):
1. `just fmt && just lint && just test && just build` - all pass
2. `cargo run -p opencode-cloud -- --help` - shows start, stop, restart commands
3. `cargo run -p opencode-cloud -- start --help` - shows --port, --open flags
4. `cargo run -p opencode-cloud -- stop --help` - shows stop command help
5. `cargo run -p opencode-cloud -- restart --help` - shows restart command help
</verification>

<success_criteria>
- Start command exists with --port and --open flags
- Stop command exists with 30s graceful timeout
- Restart command exists (combines stop + start)
- CommandSpinner provides elapsed time feedback
- Commands are idempotent (no error when already in target state)
- Quiet mode suppresses spinner output
- All pre-commit checks pass (fmt, lint, test, build)
</success_criteria>

<output>
After completion, create `.planning/phases/03-service-lifecycle-commands/03-01-SUMMARY.md`
</output>
