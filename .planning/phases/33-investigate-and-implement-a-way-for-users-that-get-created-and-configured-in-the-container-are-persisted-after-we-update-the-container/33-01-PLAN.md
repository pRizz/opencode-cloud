---
phase: 33-investigate-and-implement-a-way-for-users-that-get-created-and-configured-in-the-container-are-persisted-after-we-update-the-container
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/docker/volume.rs
  - packages/core/src/docker/container.rs
  - packages/core/src/docker/users.rs
  - packages/core/src/docker/mod.rs
  - packages/cli-rust/src/commands/user/add.rs
  - packages/cli-rust/src/commands/user/remove.rs
  - packages/cli-rust/src/commands/user/passwd.rs
  - packages/cli-rust/src/commands/user/disable.rs
  - packages/cli-rust/src/commands/user/enable.rs
  - README.md
autonomous: true

must_haves:
  truths:
    - "User accounts survive container rebuilds and updates"
    - "Passwords continue working after rebuild/update"
    - "`occ start` and `occ update` behave consistently for users"
  artifacts:
    - path: "packages/core/src/docker/volume.rs"
      provides: "New managed volume for user persistence"
      contains: "users"
    - path: "packages/core/src/docker/users.rs"
      provides: "Persist/restore user records"
      contains: "persist"
    - path: "packages/core/src/docker/mod.rs"
      provides: "Restore users on setup/start"
      contains: "restore"
---

<objective>
Persist container users across updates/rebuilds using Option D: store user state in a managed volume and restore it automatically.

Purpose: Ensure user accounts and passwords survive container recreation without storing plaintext in host config.
Output: A new persistence store, wired into user commands and container setup.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-investigate-and-implement-a-way-for-users-that-get-created-and-configured-in-the-container-are-persisted-after-we-update-the-container/33-CONTEXT.md
@packages/core/src/docker/volume.rs
@packages/core/src/docker/container.rs
@packages/core/src/docker/users.rs
@packages/core/src/docker/mod.rs
@packages/cli-rust/src/commands/user
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define persistence store and format</name>
  <files>packages/core/src/docker/users.rs</files>
  <action>
Decide on the persisted data format and storage path inside the new volume:
- Location (e.g., `/var/lib/opencode-users`)
- Per-user record format (JSON or shadow-line)
- Required fields (username, password hash, locked status)
Add helper functions for read/write and list.
  </action>
  <verify>
Document the chosen format in comments and ensure permissions are strict.
  </verify>
  <done>
Persistence helpers are implemented with a clear format and path.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add volume and mount for user store</name>
  <files>packages/core/src/docker/volume.rs, packages/core/src/docker/container.rs</files>
  <action>
Add a new managed Docker volume and mount it into the container at the persistence path.
Ensure volume is created with existing volume lifecycle logic and mounted on container creation.
  </action>
  <verify>
Container creation uses the new mount and volume list includes the new entry.
  </verify>
  <done>
User store volume is created and mounted during container creation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Persist and restore users in CLI flows</name>
  <files>packages/cli-rust/src/commands/user/*.rs, packages/core/src/docker/mod.rs</files>
  <action>
Ensure all user mutations update the persisted store:
- add/passwd/enable/disable/remove
Restore users from the store after container start (e.g., in `setup_and_start`).
  </action>
  <verify>
Users and passwords survive: start → recreate container → start.
  </verify>
  <done>
All user changes update the store and restore logic runs automatically.
  </done>
</task>

<task type="auto">
  <name>Task 4: Documentation and warnings</name>
  <files>README.md</files>
  <action>
Add a brief note describing that user accounts persist across updates/rebuilds and where they are stored.
  </action>
  <verify>
Docs match actual behavior and avoid implying plaintext password storage.
  </verify>
  <done>
User persistence behavior documented.
  </done>
</task>

</tasks>

<verification>
1. Rebuild or update preserves user accounts and passwords
2. Start/update flows are consistent with user persistence
3. Persisted store is secured and not stored in config
</verification>

<success_criteria>
- `occ start` preserves users after container recreate
- `occ update container` preserves passwords without reset
- Persisted store uses managed volume and secure permissions
</success_criteria>

<output>
After completion, create `.planning/phases/33-investigate-and-implement-a-way-for-users-that-get-created-and-configured-in-the-container-are-persisted-after-we-update-the-container/33-01-SUMMARY.md`
</output>
