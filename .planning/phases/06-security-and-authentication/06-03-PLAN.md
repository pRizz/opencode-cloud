---
phase: 06-security-and-authentication
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - packages/cli-rust/src/commands/config/set.rs
  - packages/cli-rust/src/commands/config/show.rs
  - packages/cli-rust/src/commands/config/get.rs
  - packages/cli-rust/src/commands/start.rs
  - packages/core/src/docker/container.rs
autonomous: true

must_haves:
  truths:
    - "User can set bind_address via occ config set bind_address"
    - "Setting bind_address to 0.0.0.0 shows network exposure warning"
    - "Container port binding uses configured bind_address (not hardcoded 127.0.0.1)"
    - "occ start shows warning when network exposed"
  artifacts:
    - path: "packages/cli-rust/src/commands/config/set.rs"
      provides: "Config set with bind_address validation and warning"
      contains: "bind_address"
    - path: "packages/core/src/docker/container.rs"
      provides: "Container creation with configurable bind address"
      contains: "bind_address"
  key_links:
    - from: "packages/cli-rust/src/commands/start.rs"
      to: "config.bind_address"
      via: "Config load and container creation"
      pattern: "config\\.bind_address"
---

<objective>
Implement network binding controls - bind_address configuration, validation, warnings, and container port binding.

Purpose: Security requirement SECU-02 and SECU-03 - service binds to localhost by default with explicit opt-in for network exposure. This plan implements the config flow and container binding integration.

Output: Config set/show/get support bind_address with validation, warnings on network exposure, container creation uses configured bind address.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-security-and-authentication/06-CONTEXT.md
@.planning/phases/06-security-and-authentication/06-RESEARCH.md
@packages/cli-rust/src/commands/config/set.rs
@packages/cli-rust/src/commands/start.rs
@packages/core/src/docker/container.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add bind_address support to config commands</name>
  <files>packages/cli-rust/src/commands/config/set.rs, packages/cli-rust/src/commands/config/show.rs, packages/cli-rust/src/commands/config/get.rs</files>
  <action>
**Update set.rs:**
Add "bind_address" | "bind" case to the match statement:
1. Parse the value using validate_bind_address() from core (import it)
2. If parsing fails, return error with valid examples: "Invalid address. Use: 127.0.0.1, ::1, 0.0.0.0, or ::"
3. If value is "0.0.0.0" or "::":
   - Show multi-line warning in yellow:
     ```
     WARNING: Network exposure enabled!

     Binding to {addr} exposes the service to all network interfaces.
     Anyone on your network can access the opencode web UI.

     Recommendations:
     - Ensure strong authentication is configured (occ user add)
     - Consider using a firewall to restrict access
     - For internet exposure, use a reverse proxy with TLS

     To bind to localhost only: occ config set bind_address 127.0.0.1
     ```
4. Save the validated address string to config.bind_address (store as string, not IpAddr)

Add aliases: "bind_address", "bind", "host" all map to bind_address

**Update show.rs:**
- Add bind_address to the table output
- For MaskedConfig, show bind_address value
- Color code: green if localhost (127.0.0.1, ::1), yellow if network exposed (0.0.0.0, ::)

**Update get.rs:**
- Add "bind_address" | "bind" | "host" case to return config.bind_address
  </action>
  <verify>`occ config set bind_address 0.0.0.0` shows warning, `occ config show` displays bind_address</verify>
  <done>Config commands support bind_address with validation and network exposure warning</done>
</task>

<task type="auto">
  <name>Task 2: Update container creation to use configured bind address</name>
  <files>packages/core/src/docker/container.rs</files>
  <action>
Update create_container function signature to accept bind_address parameter:

1. Add parameter: `bind_address: Option<&str>` (defaults to "127.0.0.1" if None)

2. Update port_bindings creation:
   ```rust
   let bind_addr = bind_address.unwrap_or("127.0.0.1");
   port_bindings.insert(
       "3000/tcp".to_string(),
       Some(vec![PortBinding {
           host_ip: Some(bind_addr.to_string()),
           host_port: Some(port.to_string()),
       }]),
   );
   ```

3. If bind_address is an IPv6 address (contains ":"), also add IPv6 binding:
   - For "::" (all interfaces), bind to both 0.0.0.0 and ::
   - For "::1" (localhost), bind to both 127.0.0.1 and ::1

   Actually, simpler approach: just use the exact address provided. Docker handles the rest.

Update setup_and_start to pass bind_address:
- Add bind_address parameter: `bind_address: Option<&str>`
- Pass it through to create_container

Update any callers in the codebase (likely just start.rs uses setup_and_start).
  </action>
  <verify>`just build` compiles, container.rs has bind_address parameter</verify>
  <done>Container creation uses configured bind_address instead of hardcoded 127.0.0.1</done>
</task>

<task type="auto">
  <name>Task 3: Update start command with security checks and warnings</name>
  <files>packages/cli-rust/src/commands/start.rs</files>
  <action>
Update cmd_start to:

1. Load config at the beginning (it's already loaded for port, extend usage):
   ```rust
   let config = opencode_cloud_core::config::load_config()?;
   let port = args.port.unwrap_or(config.opencode_web_port);
   let bind_addr = &config.bind_address;
   ```

2. Add security check before starting:
   - If config.is_network_exposed():
     - If config.users.is_empty() AND !config.allow_unauthenticated_network:
       Show warning (but don't block - per CONTEXT.md "allow starting with 0.0.0.0 and no users"):
       ```
       WARNING: Network exposed without authentication!

       The service is bound to {bind_addr} but no users are configured.
       Anyone on your network can access the web UI without authentication.

       To add a user: occ user add
       To suppress this warning: occ config set allow_unauthenticated_network true
       ```
     - Show brief reminder on every network-exposed start:
       ```
       Note: Service is network-exposed ({bind_addr})
       ```

3. Pass bind_address to setup_and_start:
   ```rust
   let container_id = start_container(&client, port, &bind_addr).await?;
   ```

4. Update start_container helper to accept bind_address and pass it through

5. Update show_start_result to show the actual URL with configured bind:
   - If localhost: `http://127.0.0.1:{port}`
   - If network exposed: `http://0.0.0.0:{port}` and note "accessible on all network interfaces"

6. Add "Security" indicator to output:
   - If localhost: `Security:    [LOCAL ONLY]` (green)
   - If network exposed: `Security:    [NETWORK EXPOSED]` (yellow)
  </action>
  <verify>`just test` passes, start command shows security status</verify>
  <done>Start command loads bind_address from config, shows security warnings, passes to container creation</done>
</task>

</tasks>

<verification>
After all tasks:
1. `just fmt` - Code is formatted
2. `just lint` - No clippy warnings
3. `just test` - All tests pass
4. `just build` - Release build succeeds
5. `occ config set bind_address 0.0.0.0` shows detailed warning
6. `occ config show` displays bind_address with color coding
7. Container creation signature accepts bind_address parameter
</verification>

<success_criteria>
- occ config set bind_address validates IPv4/IPv6 addresses
- Setting 0.0.0.0 or :: shows multi-line security warning
- occ config show displays bind_address (green for localhost, yellow for exposed)
- occ start shows brief network exposure note when applicable
- occ start shows Security status line (LOCAL ONLY or NETWORK EXPOSED)
- Container is created with configured bind_address (not hardcoded)
- Warning shown if network exposed without users configured
</success_criteria>

<output>
After completion, create `.planning/phases/06-security-and-authentication/06-03-SUMMARY.md`
</output>
