---
phase: 06-security-and-authentication
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - packages/cli-rust/src/commands/user/mod.rs
  - packages/cli-rust/src/commands/user/add.rs
  - packages/cli-rust/src/commands/user/remove.rs
  - packages/cli-rust/src/commands/user/list.rs
  - packages/cli-rust/src/commands/user/passwd.rs
  - packages/cli-rust/src/commands/user/enable.rs
  - packages/cli-rust/src/commands/mod.rs
  - packages/cli-rust/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "User can add a user to the container via occ user add"
    - "User can remove a user from the container via occ user remove"
    - "User can list all users via occ user list"
    - "User can change password via occ user passwd"
    - "User can enable/disable accounts via occ user enable/disable"
  artifacts:
    - path: "packages/cli-rust/src/commands/user/mod.rs"
      provides: "User command router"
      exports: ["UserArgs", "cmd_user"]
    - path: "packages/cli-rust/src/commands/user/add.rs"
      provides: "occ user add implementation"
      contains: "cmd_user_add"
    - path: "packages/cli-rust/src/commands/user/list.rs"
      provides: "occ user list implementation"
      contains: "cmd_user_list"
  key_links:
    - from: "packages/cli-rust/src/commands/user/add.rs"
      to: "opencode_cloud_core::docker::users"
      via: "create_user, set_user_password calls"
      pattern: "create_user.*container"
---

<objective>
Implement occ user CLI commands for managing container users (add, remove, list, passwd, enable, disable).

Purpose: PAM-based authentication requires managing system users in the container. These commands allow the user to create and manage accounts that opencode authenticates against via PAM.

Output: Complete occ user command tree with add (--generate option), remove (--force option), list (table output), passwd, enable, disable subcommands.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-security-and-authentication/06-CONTEXT.md
@.planning/phases/06-security-and-authentication/06-RESEARCH.md
@packages/cli-rust/src/commands/config/mod.rs (pattern for nested subcommands)
@packages/cli-rust/src/commands/setup.rs (pattern for interactive prompts)
@packages/cli-rust/src/wizard/auth.rs (random password generation pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create user command module structure and add/remove</name>
  <files>packages/cli-rust/src/commands/user/mod.rs, packages/cli-rust/src/commands/user/add.rs, packages/cli-rust/src/commands/user/remove.rs</files>
  <action>
Create `packages/cli-rust/src/commands/user/` directory with module structure.

**mod.rs:**
- Define UserArgs struct with clap
- Define UserCommands enum with Add, Remove, List, Passwd, Enable, Disable variants
- Each variant holds its args struct
- Router function `cmd_user(args: &UserArgs, quiet: bool, verbose: u8) -> Result<()>`
- Check container is running first: if not, error with "Container not running. Start with `occ start` first."

**add.rs:**
- UserAddArgs: username (optional), --generate flag for random password
- `cmd_user_add(args: &UserAddArgs, quiet: bool, verbose: u8) -> Result<()>`
- Flow:
  1. Connect to Docker, verify container running
  2. If username not provided, prompt interactively (default: "opencode")
  3. Validate username: 3-32 chars, alphanumeric + underscore only (reuse pattern from config/set.rs)
  4. Check if user already exists via user_exists() - error if so
  5. If --generate: create 24-char random alphanumeric password (use rand like wizard/auth.rs)
  6. If not --generate: prompt for password with confirmation using dialoguer::Password
  7. Create user via create_user()
  8. Set password via set_user_password()
  9. Update config: add username to config.users array and save
  10. Display success message (show generated password if --generate, masked otherwise)

**remove.rs:**
- UserRemoveArgs: username (required), --force flag
- `cmd_user_remove(args: &UserRemoveArgs, quiet: bool, verbose: u8) -> Result<()>`
- Flow:
  1. Connect to Docker, verify container running
  2. Check user exists via user_exists() - error if not
  3. Check if this is the last user (config.users.len() == 1 after removal):
     - If yes and no --force: error "Cannot remove last user. Add another user first or use --force."
  4. If not --force: prompt for confirmation using dialoguer::Confirm
  5. Delete user via delete_user()
  6. Update config: remove username from config.users array and save
  7. Display success message
  </action>
  <verify>`just build` compiles user module</verify>
  <done>user/mod.rs, user/add.rs, user/remove.rs exist with container running check and config persistence</done>
</task>

<task type="auto">
  <name>Task 2: Implement list, passwd, enable/disable commands</name>
  <files>packages/cli-rust/src/commands/user/list.rs, packages/cli-rust/src/commands/user/passwd.rs, packages/cli-rust/src/commands/user/enable.rs</files>
  <action>
**list.rs:**
- UserListArgs: empty (no arguments)
- `cmd_user_list(args: &UserListArgs, quiet: bool, verbose: u8) -> Result<()>`
- Flow:
  1. Connect to Docker, verify container running
  2. Call list_users() to get Vec<UserInfo>
  3. If quiet: print just usernames, one per line
  4. If not quiet: display as table using comfy-table:
     - Columns: Username, Status, UID, Home, Shell
     - Status column: "enabled" (green) or "disabled" (yellow) based on locked field
  5. If no users: print "No users configured."

**passwd.rs:**
- UserPasswdArgs: username (required)
- `cmd_user_passwd(args: &UserPasswdArgs, quiet: bool, verbose: u8) -> Result<()>`
- Flow:
  1. Connect to Docker, verify container running
  2. Check user exists via user_exists() - error if not
  3. Prompt for new password with confirmation using dialoguer::Password
  4. Set password via set_user_password()
  5. Display success message
- Note: No current password verification required (CLI user has shell access anyway per CONTEXT.md)

**enable.rs:**
- UserEnableArgs: username (required)
- UserDisableArgs: username (required)
- `cmd_user_enable(args: &UserEnableArgs, quiet: bool, verbose: u8) -> Result<()>`
- `cmd_user_disable(args: &UserDisableArgs, quiet: bool, verbose: u8) -> Result<()>`
- Enable flow:
  1. Connect to Docker, verify container running
  2. Check user exists
  3. Call unlock_user()
  4. Display success: "User '{username}' enabled."
- Disable flow:
  1. Connect to Docker, verify container running
  2. Check user exists
  3. Call lock_user()
  4. Display success: "User '{username}' disabled."
  </action>
  <verify>`just build` compiles all user subcommands</verify>
  <done>user/list.rs, user/passwd.rs, user/enable.rs exist with table output and password prompts</done>
</task>

<task type="auto">
  <name>Task 3: Wire user commands into CLI and verify full tree</name>
  <files>packages/cli-rust/src/commands/mod.rs, packages/cli-rust/src/lib.rs</files>
  <action>
**Update commands/mod.rs:**
- Add `pub mod user;`
- Add to exports: `pub use user::{UserArgs, cmd_user};`

**Update lib.rs:**
- Add User variant to Commands enum with #[command(subcommand)]
- Add User(user::UserArgs) to the enum
- Add match arm in run() to call cmd_user()

**Verify the full command tree works:**
- `occ user --help` shows subcommands
- `occ user add --help` shows --generate flag
- `occ user remove --help` shows --force flag
- `occ user list --help` works
- `occ user passwd --help` works
- `occ user enable --help` and `occ user disable --help` work

Run pre-commit checks:
- `just fmt`
- `just lint`
- `just test`
- `just build`
  </action>
  <verify>`occ user --help` displays all subcommands, `just test` passes</verify>
  <done>occ user command tree complete with add, remove, list, passwd, enable, disable</done>
</task>

</tasks>

<verification>
After all tasks:
1. `just fmt` - Code is formatted
2. `just lint` - No clippy warnings
3. `just test` - All tests pass
4. `just build` - Release build succeeds
5. `occ user --help` shows subcommands
6. Manual test (if container available): `occ user add --generate` creates user with random password
</verification>

<success_criteria>
- occ user add creates user with password (--generate for random, interactive prompt otherwise)
- occ user remove deletes user (--force to skip confirmation, prevents removing last user)
- occ user list shows table with Username, Status, UID, Home, Shell
- occ user passwd changes password interactively
- occ user enable/disable locks/unlocks account
- All commands check container is running first with clear error message
- User additions/removals update config.users array for persistence tracking
</success_criteria>

<output>
After completion, create `.planning/phases/06-security-and-authentication/06-02-SUMMARY.md`
</output>
