---
phase: 06-security-and-authentication
plan: 04
type: execute
wave: 3
depends_on: ["06-02", "06-03"]
files_modified:
  - packages/cli-rust/src/commands/status.rs
  - packages/cli-rust/src/wizard/auth.rs
  - packages/cli-rust/src/wizard/mod.rs
autonomous: true

must_haves:
  truths:
    - "occ status displays Security section with binding, auth, and warnings"
    - "Setup wizard creates first user in container via PAM flow"
    - "User list is displayed in status output"
  artifacts:
    - path: "packages/cli-rust/src/commands/status.rs"
      provides: "Status with Security section"
      contains: "Security:"
    - path: "packages/cli-rust/src/wizard/auth.rs"
      provides: "Wizard creates container user"
      contains: "create_user"
  key_links:
    - from: "packages/cli-rust/src/commands/status.rs"
      to: "config.bind_address"
      via: "Config load and display"
      pattern: "config\\.bind_address"
    - from: "packages/cli-rust/src/wizard/auth.rs"
      to: "opencode_cloud_core::docker::users"
      via: "create_user call"
      pattern: "create_user"
---

<objective>
Enhance status display with Security section and update wizard to create container users via PAM.

Purpose: Make security configuration visible at a glance (SECU-03 status requirement) and integrate PAM user creation into the setup wizard (SECU-01 requirement for basic auth).

Output: occ status shows Security section with binding, auth status, user list; wizard creates users in container with random or prompted password.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-security-and-authentication/06-CONTEXT.md
@.planning/phases/06-security-and-authentication/06-RESEARCH.md
@packages/cli-rust/src/commands/status.rs
@packages/cli-rust/src/wizard/auth.rs
@packages/cli-rust/src/wizard/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Security section to status command</name>
  <files>packages/cli-rust/src/commands/status.rs</files>
  <action>
Add a dedicated "Security" section to status output after the existing info:

1. Load config at beginning if not already loaded:
   ```rust
   let config = opencode_cloud_core::config::load_config().ok();
   ```

2. After the existing status output (Installed: line), add Security section:
   ```

   Security
   --------
   Binding:     127.0.0.1 [LOCAL ONLY]  // or 0.0.0.0 [NETWORK EXPOSED]
   Auth users:  admin, dev  // or "None configured" in yellow
   Trust proxy: no  // or "yes" if trust_proxy is true
   ```

3. Format the Security section:
   - "Binding:" shows bind_address with badge:
     - `[LOCAL ONLY]` in green for localhost (127.0.0.1, ::1)
     - `[NETWORK EXPOSED]` in yellow for 0.0.0.0, ::
   - "Auth users:" shows comma-separated list from config.users
     - If empty: show "None configured" in yellow
   - "Trust proxy:" shows "yes" or "no"
   - "Rate limit:" shows "{attempts} attempts / {window}s window"

4. If network exposed without users, show warning at the end:
   ```

   Warning: Network exposed without authentication!
   Add users: occ user add
   ```

5. Only show Security section when container exists (whether running or stopped).
   The security config is relevant even when stopped.
  </action>
  <verify>`occ status` (with container) shows Security section</verify>
  <done>Status command displays Security section with binding, auth users, trust proxy, rate limit</done>
</task>

<task type="auto">
  <name>Task 2: Update wizard to create container users</name>
  <files>packages/cli-rust/src/wizard/auth.rs, packages/cli-rust/src/wizard/mod.rs</files>
  <action>
Update wizard/auth.rs to create actual container users instead of just setting config:

**In auth.rs:**

1. Add imports for Docker user operations:
   ```rust
   use opencode_cloud_core::docker::{
       DockerClient, CONTAINER_NAME, create_user, set_user_password, user_exists
   };
   ```

2. Update `prompt_auth_credentials` return type to include whether container user should be created:
   - Return struct: `AuthConfig { username: String, password: String, create_in_container: bool }`
   - create_in_container is true when running full wizard with container

3. Add new function `create_container_user`:
   ```rust
   pub async fn create_container_user(
       client: &DockerClient,
       username: &str,
       password: &str,
   ) -> Result<()> {
       // Check if user already exists
       if user_exists(client, CONTAINER_NAME, username).await? {
           // User exists, just update password
           println!("  User '{}' exists, updating password...", username);
       } else {
           // Create new user
           println!("  Creating user '{}' in container...", username);
           create_user(client, CONTAINER_NAME, username).await?;
       }

       // Set password
       set_user_password(client, CONTAINER_NAME, username, password).await?;
       println!("  Password set for '{}'", username);

       Ok(())
   }
   ```

**In mod.rs (run_wizard):**

1. After collecting auth credentials and before saving config:
   - If container is running: create the user in container
   - If container not running: note that user will be created on first start

   ```rust
   // Create user in container if running
   if container_running {
       println!();
       println!("{}", style("Creating user in container...").cyan());
       create_container_user(&client, &state.username, &state.password).await?;
   } else {
       println!();
       println!(
           "{}",
           style("Note: User will be created when container starts.").dim()
       );
   }
   ```

2. Update config.users array to include the new username (for persistence)

3. The existing auth_username/auth_password fields in config become DEPRECATED:
   - Keep them for backward compatibility
   - But primary user management is now via config.users + PAM

Actually, looking at CONTEXT.md more carefully:
- "User storage: Config mirrors container - tracks usernames (not passwords) for status/management"
- The auth_username/auth_password in config was from Phase 5, before PAM decision

So the flow should be:
1. Wizard prompts for username (default "opencode") and password
2. If container running: create user via PAM immediately
3. Add username to config.users
4. On container rebuild: recreate users from config.users (handled elsewhere)

Remove or deprecate auth_username/auth_password usage in wizard - use config.users instead.
  </action>
  <verify>`occ setup` with running container creates user in container</verify>
  <done>Wizard creates container users via create_user/set_user_password, updates config.users</done>
</task>

<task type="auto">
  <name>Task 3: Add first-start security check</name>
  <files>packages/cli-rust/src/commands/start.rs</files>
  <action>
Update start command to enforce security configuration on first start:

1. At the beginning of cmd_start, after loading config:
   ```rust
   // Security check: block first start without security configured
   if config.users.is_empty() && !config.allow_unauthenticated_network {
       // Check if this is a "first start" scenario
       // First start = no container exists yet
       let is_first_start = !container_exists(&client, CONTAINER_NAME).await?;

       if is_first_start {
           return Err(anyhow!(
               "{}\n\n  {}\n  {}",
               style("Security not configured").red().bold(),
               "No users configured. Run setup first:",
               style("  occ setup").cyan()
           ));
       }
   }
   ```

2. This enforces CONTEXT.md: "First start without security: Block with setup prompt"

3. However, if container already exists (not first start), allow starting even without users.
   This handles the case where user manually configured things or removed users.

4. The allow_unauthenticated_network flag bypasses this check for users who explicitly opt-in.

5. Add helpful message when blocking:
   ```
   Security not configured

   No users are configured for authentication.

   Quick setup:
     occ setup

   Or add a user manually:
     occ start && occ user add
   ```

Actually wait - if we block start, user can't add users because container isn't running.
Let me reconsider...

Per CONTEXT.md: "Container state: Error immediately if container not running - 'Container not running. Start with `occ start` first.'"

This creates a chicken-and-egg problem. Resolution:
- Allow first start without users
- But show prominent warning
- User commands create users after start

So the security check should WARN, not BLOCK, on first start without users.
Only BLOCK if allow_unauthenticated_network is false AND bind_address is exposed AND no users.

Actually, re-reading CONTEXT.md:
- "First start without security: Block with setup prompt"
- But also "Auth gate: Strong warning but allow starting with 0.0.0.0 and no users configured"

These seem contradictory. Let me reconcile:
- Block first start if no users AND no explicit allow_unauthenticated_network
- This forces user to either: run setup (which creates user), OR explicitly opt-in to unauthenticated

The resolution to chicken-and-egg:
- occ setup can start the container as part of its flow
- OR add --allow-unauthenticated flag to first start
- OR use allow_unauthenticated_network config

Simplest: Block and suggest `occ setup` which handles everything.
  </action>
  <verify>`occ start` without users blocks with setup prompt (unless opted out)</verify>
  <done>First start blocked without security, prompts for occ setup</done>
</task>

</tasks>

<verification>
After all tasks:
1. `just fmt` - Code is formatted
2. `just lint` - No clippy warnings
3. `just test` - All tests pass
4. `just build` - Release build succeeds
5. `occ status` shows Security section with Binding, Auth users, Trust proxy
6. Wizard creates user in container when container is running
7. First start without users shows security block message
</verification>

<success_criteria>
- occ status displays Security section with all relevant info
- Security section shows bind address with badge, user list, trust proxy, rate limit
- Warning shown in status if network exposed without users
- Wizard creates container user via create_user + set_user_password
- Wizard updates config.users array
- First start blocked without security configured (unless opted out)
- Block message suggests occ setup
</success_criteria>

<output>
After completion, create `.planning/phases/06-security-and-authentication/06-04-SUMMARY.md`
</output>
