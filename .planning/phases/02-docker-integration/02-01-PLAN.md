---
phase: 02-docker-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/Cargo.toml
  - packages/core/src/lib.rs
  - packages/core/src/docker/mod.rs
  - packages/core/src/docker/client.rs
  - packages/core/src/docker/error.rs
  - packages/core/src/docker/dockerfile.rs
  - Cargo.toml
autonomous: true

must_haves:
  truths:
    - "Docker client connects to local Docker daemon"
    - "Connection errors provide clear, actionable messages"
    - "Dockerfile content is accessible programmatically"
  artifacts:
    - path: "packages/core/src/docker/mod.rs"
      provides: "Docker module exports"
      exports: ["DockerClient", "DockerError"]
    - path: "packages/core/src/docker/client.rs"
      provides: "Docker client wrapper with connection handling"
      min_lines: 40
    - path: "packages/core/src/docker/error.rs"
      provides: "Docker-specific error types"
      contains: "enum DockerError"
    - path: "packages/core/src/docker/dockerfile.rs"
      provides: "Embedded Dockerfile content"
      contains: "DOCKERFILE"
  key_links:
    - from: "packages/core/src/docker/client.rs"
      to: "bollard::Docker"
      via: "connect_with_local_defaults"
      pattern: "Docker::connect_with_local"
    - from: "packages/core/src/lib.rs"
      to: "packages/core/src/docker/mod.rs"
      via: "pub mod docker"
      pattern: "pub mod docker"
---

<objective>
Create Docker client foundation and Dockerfile for opencode container image.

Purpose: Establish the Docker operations module with a wrapped Bollard client that handles connection errors gracefully, and define the Dockerfile content that will be used to build the opencode image.

Output: Docker client wrapper module with error types and embedded Dockerfile ready for image build operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-docker-integration/02-CONTEXT.md
@.planning/phases/02-docker-integration/02-RESEARCH.md

# Existing codebase structure
@packages/core/src/lib.rs
@packages/core/Cargo.toml
@Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Bollard dependencies and create Docker module structure</name>
  <files>
    Cargo.toml
    packages/core/Cargo.toml
    packages/core/src/docker/mod.rs
    packages/core/src/docker/error.rs
    packages/core/src/lib.rs
  </files>
  <action>
Add workspace dependencies to root Cargo.toml:
- bollard = { version = "0.18", features = ["chrono", "buildkit"] }
- futures-util = "0.3"
- tar = "0.4"
- flate2 = "1.0"
- tokio-retry = "0.3"
- indicatif = { version = "0.17", features = ["tokio", "futures"] }
- http-body-util = "0.1"

Add these to packages/core/Cargo.toml dependencies (use workspace = true pattern).

Create packages/core/src/docker/mod.rs:
- Declare submodules: client, error, dockerfile
- Re-export DockerClient from client
- Re-export DockerError from error
- Re-export DOCKERFILE constant from dockerfile

Create packages/core/src/docker/error.rs:
- Define DockerError enum using thiserror
- Variants: Connection(String), Build(String), Pull(String), Container(String), Volume(String), NotRunning, Timeout
- Implement From<bollard::errors::Error> for DockerError

Update packages/core/src/lib.rs:
- Add pub mod docker;
- Add re-exports: pub use docker::{DockerClient, DockerError};
  </action>
  <verify>
cargo check -p opencode-cloud-core
  </verify>
  <done>
Docker module compiles with error types. Dependencies added to workspace.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Docker client wrapper</name>
  <files>packages/core/src/docker/client.rs</files>
  <action>
Create DockerClient struct wrapping bollard::Docker with these methods:

```rust
pub struct DockerClient {
    inner: Docker,
}

impl DockerClient {
    /// Create new client connecting to local Docker daemon
    /// Uses platform-appropriate socket (Unix socket on Linux/macOS)
    pub fn new() -> Result<Self, DockerError>

    /// Create client with custom timeout (in seconds)
    /// Use for long-running operations like builds
    pub fn with_timeout(timeout_secs: u64) -> Result<Self, DockerError>

    /// Verify connection to Docker daemon
    /// Returns Ok(()) if connected, descriptive error otherwise
    pub async fn verify_connection(&self) -> Result<(), DockerError>

    /// Get Docker version info (useful for debugging)
    pub async fn version(&self) -> Result<String, DockerError>

    /// Access inner Bollard client for advanced operations
    pub fn inner(&self) -> &Docker
}
```

Connection error handling:
- If Docker not running: "Docker daemon not running. Start Docker Desktop or the Docker service."
- If permission denied: "Permission denied accessing Docker socket. You may need to add your user to the 'docker' group."
- Generic connection error: Include the underlying error message

Use connect_with_local_defaults() for automatic platform detection.
Default timeout: 120 seconds. Build timeout: 600 seconds (10 min).
  </action>
  <verify>
cargo check -p opencode-cloud-core && cargo test -p opencode-cloud-core docker
  </verify>
  <done>
DockerClient connects to Docker daemon with clear error messages when Docker is unavailable.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create embedded Dockerfile</name>
  <files>packages/core/src/docker/dockerfile.rs</files>
  <action>
Create dockerfile.rs with the Dockerfile content as a const string based on 02-CONTEXT.md decisions.

```rust
/// The Dockerfile for building the opencode-cloud-sandbox container image
pub const DOCKERFILE: &str = include_str!("Dockerfile");

/// Docker image name for Docker Hub (primary)
pub const IMAGE_NAME_DOCKERHUB: &str = "prizz/opencode-cloud-sandbox";

/// Docker image name for GHCR (fallback mirror)
pub const IMAGE_NAME_GHCR: &str = "ghcr.io/prizz/opencode-cloud-sandbox";

/// Default image tag
pub const IMAGE_TAG_DEFAULT: &str = "latest";
```

Create packages/core/src/docker/Dockerfile (the actual Dockerfile to be embedded):

Multi-stage build with these characteristics from CONTEXT.md:
- Stage 1 (builder): Install build dependencies
- Stage 2 (runtime): Final image

Base: Ubuntu 24.04 LTS (noble)

Must include (from CONTEXT.md decisions):
- Non-root 'opencode' user with passwordless sudo
- tini/dumb-init for signal handling
- zsh + oh-my-zsh + starship prompt
- tmux, vim, neovim, nano
- Node.js, Python, Rust, Go via mise
- pnpm (no yarn)
- Python: uv package manager
- Developer tools: curl, wget, htop, build-essential, jq, yq, git
- Modern CLI: ripgrep, bat, eza, fzf, fd, lazygit, delta, difftastic, direnv
- Just, HTTPie, shellcheck, shfmt, tree, glow
- Modern system tools: procs, dust, duf, btop
- GitHub CLI (gh)
- Compression: zip, unzip, 7z, xz
- Database clients: sqlite3, psql, mysql
- Container tools: kubectl, helm, k9s, dive
- Security: trivy, gitleaks, hadolint, age, sops, mkcert
- CI/CD: act
- Rust tooling: cargo-nextest, cargo-audit, cargo-deny, sccache, mold, cross
- Code quality: prettier, black, eslint, ruff, biome, jest/vitest/pytest
- GSD plugin: installed from https://github.com/rokicool/gsd-opencode
- protobuf compiler + grpcurl

HEALTHCHECK: curl to localhost health endpoint
WORKDIR: /home/opencode
Entrypoint: opencode web
OCI labels for metadata

Keep the Dockerfile well-commented explaining each section. Group related installations.
This will be a large file (300-400 lines) - that's expected for a comprehensive dev container.
  </action>
  <verify>
cargo check -p opencode-cloud-core
# Verify Dockerfile syntax (if hadolint available):
command -v hadolint && hadolint packages/core/src/docker/Dockerfile || echo "hadolint not installed, skipping lint"
  </verify>
  <done>
Dockerfile is embedded in Rust code and accessible via DOCKERFILE constant. Image names and default tag defined.
  </done>
</task>

</tasks>

<verification>
1. `cargo check -p opencode-cloud-core` passes
2. `cargo build -p opencode-cloud-core` succeeds
3. Docker module exports are accessible from lib.rs
4. DockerError implements std::error::Error
5. DOCKERFILE constant contains valid Dockerfile syntax
</verification>

<success_criteria>
- Docker client wrapper created with connection handling
- Clear error messages for common Docker issues (not running, permissions)
- Dockerfile content embedded and accessible
- All Bollard/indicatif dependencies added to workspace
- Module structure follows existing codebase patterns (like config/)
</success_criteria>

<output>
After completion, create `.planning/phases/02-docker-integration/02-01-SUMMARY.md`
</output>
