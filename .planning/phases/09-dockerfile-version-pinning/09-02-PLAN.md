---
phase: 09-dockerfile-version-pinning
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - scripts/check-dockerfile-updates.sh
  - justfile
  - .github/workflows/dockerfile-updates.yml
autonomous: true

must_haves:
  truths:
    - "User can run just check-updates to see available version updates"
    - "Script reports available updates with current vs latest versions"
    - "Weekly CI creates PR with accumulated updates"
  artifacts:
    - path: "scripts/check-dockerfile-updates.sh"
      provides: "Update checker script"
      min_lines: 50
    - path: ".github/workflows/dockerfile-updates.yml"
      provides: "Weekly CI automation"
      contains: "schedule:"
    - path: "justfile"
      provides: "check-updates command"
      contains: "check-updates:"
  key_links:
    - from: "scripts/check-dockerfile-updates.sh"
      to: "packages/core/src/docker/Dockerfile"
      via: "grep version extraction"
      pattern: "grep.*Dockerfile"
    - from: ".github/workflows/dockerfile-updates.yml"
      to: "scripts/check-dockerfile-updates.sh"
      via: "script invocation"
      pattern: "./scripts/check-dockerfile-updates.sh"
---

<objective>
Create version update tooling with CI automation

Purpose: Enable automated discovery of available updates and weekly PR creation for version bumps
Output: Update checker script, just command, and GitHub Actions workflow
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-dockerfile-version-pinning/09-CONTEXT.md
@.planning/phases/09-dockerfile-version-pinning/09-RESEARCH.md
@packages/core/src/docker/Dockerfile
@justfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create check-dockerfile-updates.sh script</name>
  <files>scripts/check-dockerfile-updates.sh</files>
  <action>
Create a bash script that checks for available version updates for Dockerfile tools.

**Script requirements:**
- Use `set -euo pipefail` for safety
- Query GitHub API `/releases/latest` for each tool
- Extract current versions from Dockerfile comments (pattern: `# tool vX.Y.Z`)
- Compare and report differences
- Support `--apply` flag to update Dockerfile in-place (optional, for CI)

**Tools to check (GitHub API):**
- mikefarah/yq
- junegunn/fzf
- nektos/act
- jesseduffield/lazygit
- fullstorydev/grpcurl
- mvdan/sh (shfmt)
- starship/starship

**Cargo crates (crates.io API):**
- ripgrep
- eza
- cargo-nextest
- cargo-audit
- cargo-deny

**Output format:**
```
Checking Dockerfile tool versions...

Tool            Current    Latest     Status
----            -------    ------     ------
yq              v4.50.1    v4.50.1    up-to-date
fzf             v0.67.0    v0.68.0    UPDATE AVAILABLE
lazygit         v0.58.1    v0.58.1    up-to-date
...

Summary: 2 updates available

Updates available:
- fzf: v0.67.0 -> v0.68.0 (https://github.com/junegunn/fzf/releases/tag/v0.68.0)
```

**Implementation pattern from RESEARCH.md:**
```bash
get_latest_github_version() {
    local owner="$1"
    local repo="$2"
    curl -s "https://api.github.com/repos/${owner}/${repo}/releases/latest" \
        | jq -r '.tag_name'
}

get_dockerfile_version() {
    local tool="$1"
    grep -oP "# ${tool} v\K[0-9]+\.[0-9]+\.[0-9]+" "$DOCKERFILE"
}
```

**Handle rate limiting:**
- Check X-RateLimit-Remaining header
- Warn if approaching limit (< 10 requests remaining)
- Support GITHUB_TOKEN env var for higher limits (optional)
  </action>
  <verify>
bash scripts/check-dockerfile-updates.sh --help should show usage
shellcheck scripts/check-dockerfile-updates.sh should pass
  </verify>
  <done>Update checker script created and passes shellcheck</done>
</task>

<task type="auto">
  <name>Task 2: Add just check-updates command</name>
  <files>justfile</files>
  <action>
Add a `check-updates` recipe to the justfile that runs the update checker script.

**Add to justfile:**
```just
# Check for Dockerfile tool version updates
check-updates:
    ./scripts/check-dockerfile-updates.sh
```

Place it after the lint-shell recipe for logical grouping with other script-related commands.
  </action>
  <verify>
just check-updates should run without error
grep "check-updates:" justfile should find the recipe
  </verify>
  <done>just check-updates command works</done>
</task>

<task type="auto">
  <name>Task 3: Create weekly CI workflow</name>
  <files>.github/workflows/dockerfile-updates.yml</files>
  <action>
Create a GitHub Actions workflow that runs weekly and creates a PR with updates.

**Workflow requirements:**
- Schedule: Every Monday at 9am UTC (`cron: '0 9 * * 1'`)
- Manual trigger via workflow_dispatch
- Run the check script with --apply flag
- Create PR using peter-evans/create-pull-request if changes detected

**Workflow structure from RESEARCH.md:**
```yaml
name: Check Dockerfile Updates

on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9am UTC
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  check-updates:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Check for updates
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ./scripts/check-dockerfile-updates.sh --apply > updates.md 2>&1 || true
          if git diff --quiet packages/core/src/docker/Dockerfile; then
            echo "updates_available=false" >> $GITHUB_OUTPUT
          else
            echo "updates_available=true" >> $GITHUB_OUTPUT
          fi

      - name: Create PR
        if: steps.check.outputs.updates_available == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "chore(docker): update pinned tool versions"
          body-path: updates.md
          branch: dockerfile-version-updates
          commit-message: "chore(docker): update pinned tool versions"
          labels: dependencies,docker
          delete-branch: true
```

**PR body content (updates.md):**
The script should generate markdown with:
- Summary of changes
- Links to release pages for each updated tool
- Table of current vs new versions
  </action>
  <verify>
cat .github/workflows/dockerfile-updates.yml should show valid YAML
grep "schedule:" .github/workflows/dockerfile-updates.yml should find the cron trigger
  </verify>
  <done>Weekly CI workflow created with PR automation</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `just check-updates` runs and shows tool versions
2. `shellcheck scripts/check-dockerfile-updates.sh` passes
3. `.github/workflows/dockerfile-updates.yml` exists with schedule trigger
4. `just lint-shell` passes (includes new script)
</verification>

<success_criteria>
- Update script reports current vs available versions for all pinned tools
- just check-updates command works
- Weekly CI workflow will create PR when updates available
- Script handles GitHub API rate limiting gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/09-dockerfile-version-pinning/09-02-SUMMARY.md`
</output>
