---
phase: 09-dockerfile-version-pinning
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/docker/Dockerfile
autonomous: true

must_haves:
  truths:
    - "All apt packages have explicit version constraints or UNPINNED comments"
    - "All GitHub-installed tools have explicit version tags in download URLs"
    - "All cargo install commands use @version syntax with --locked"
    - "All go install commands use @vX.Y.Z syntax"
    - "Each pinned tool has inline documentation comment"
  artifacts:
    - path: "packages/core/src/docker/Dockerfile"
      provides: "Version-pinned development container"
      contains: "# UNPINNED:"
  key_links:
    - from: "Dockerfile"
      to: "GitHub releases"
      via: "explicit version tags in URLs"
      pattern: "/download/v[0-9]+\\.[0-9]+\\.[0-9]+/"
---

<objective>
Pin explicit versions for all tools installed in the Dockerfile

Purpose: Improve security and reproducibility by eliminating floating versions and @latest references
Output: Dockerfile with all tools pinned to specific versions with inline documentation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-dockerfile-version-pinning/09-CONTEXT.md
@.planning/phases/09-dockerfile-version-pinning/09-RESEARCH.md
@packages/core/src/docker/Dockerfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pin APT packages with version wildcards</name>
  <files>packages/core/src/docker/Dockerfile</files>
  <action>
Update all apt-get install commands to use version wildcards (pkg=X.Y.*) for reproducibility while allowing patch updates.

**Security exceptions (mark with # UNPINNED comment):**
- ca-certificates - Root cert updates critical
- gnupg - Key management security
- openssh-client - Security patches critical

**Query current versions for Ubuntu 24.04 noble:**
Use `docker run --rm ubuntu:24.04 apt-cache policy <pkg>` to find current versions.

**Pattern to apply:**
```dockerfile
# Group 1: Core utilities (2026-01-22)
RUN apt-get update && apt-get install -y --no-install-recommends \
    # UNPINNED: ca-certificates - security-critical, needs auto-updates
    ca-certificates \
    git=1:2.43.* \
    curl=8.5.* \
    ...
```

Apply to all apt-get install commands in:
- Group 1: Core utilities and build tools
- Group 2: Database clients
- Group 3: Development libraries
- direnv, shellcheck, btop, mold, protobuf-compiler, gh installations
  </action>
  <verify>
grep -c "apt-get install" packages/core/src/docker/Dockerfile should show all apt commands
grep -E "install -y.*[a-z]+=.*\*|# UNPINNED:" packages/core/src/docker/Dockerfile should show version constraints or UNPINNED comments for most packages
  </verify>
  <done>All APT packages have version wildcards or explicit UNPINNED markers</done>
</task>

<task type="auto">
  <name>Task 2: Pin GitHub tools and cargo/go installs with version tags</name>
  <files>packages/core/src/docker/Dockerfile</files>
  <action>
Pin all tools installed from GitHub, cargo, and go with explicit versions.

**GitHub tools to pin (from RESEARCH.md):**

1. **yq** - Change from `/releases/latest/download/` to `/releases/download/v4.50.1/`
   Add comment: `# yq v4.50.1 (2025-12-14) - YAML processor`

2. **fzf** - Change `git clone --depth 1` to `git clone --branch v0.67.0 --depth 1`
   Add comment: `# fzf v0.67.0 (2025-11-16) - Fuzzy finder`

3. **act** - Add version to install script: `| sudo bash -s -- -b /home/opencode/.local/bin v0.2.84`
   Add comment: `# act v0.2.84 (2026-01-01) - Run GitHub Actions locally`

4. **lazygit** - Change `@latest` to `@v0.58.1`
   Add comment: `# lazygit v0.58.1 (2026-01-12) - Terminal UI for git`

5. **grpcurl** - Change `@latest` to `@v1.9.3`
   Add comment: `# grpcurl v1.9.3 - gRPC debugging tool`

6. **shfmt** - Change `@latest` to `@v3.10.0`
   Add comment: `# shfmt v3.10.0 - Shell formatter`

**Cargo crates to pin:**
```dockerfile
# Rust CLI tools - pinned versions (2026-01-22)
RUN . /home/opencode/.cargo/env \
    && cargo install --locked ripgrep@15.1.0 eza@0.23.4

# Rust development tools - pinned versions (2026-01-22)
RUN . /home/opencode/.cargo/env \
    && cargo install --locked cargo-nextest@0.9.122 cargo-audit@0.22.0 cargo-deny@0.19.0
```

**Language runtimes via mise:**
- Keep node@lts (mise handles LTS resolution)
- Keep python@3.12 (already pinned to minor)
- Change go@latest to go@1.23 (pin to minor version)

**Installers that self-manage (trust but document):**
- Oh My Zsh, Starship, mise, rustup, uv, opencode - add comment noting they self-update
  </action>
  <verify>
grep -E "@latest|/latest/download" packages/core/src/docker/Dockerfile should return 0 matches (no floating versions)
grep -E "@v?[0-9]+\.[0-9]+\.[0-9]+" packages/core/src/docker/Dockerfile should show version pins
  </verify>
  <done>All GitHub tools and cargo/go installs use explicit version tags</done>
</task>

<task type="auto">
  <name>Task 3: Add inline documentation and verify build</name>
  <files>packages/core/src/docker/Dockerfile</files>
  <action>
Ensure every pinned tool has proper inline documentation following the format from CONTEXT.md:
`# tool vX.Y.Z (YYYY-MM-DD) - purpose description`

**Review and add missing comments for:**
- All apt package groups (date header, brief purpose)
- All GitHub tools (version, date, description)
- All cargo/go installs (version, date, description)
- Curl|bash installers (note that they self-manage)

**Add header comment for version management:**
At the top of the Dockerfile (after the intro header), add:
```dockerfile
# -----------------------------------------------------------------------------
# Version Pinning Policy
# -----------------------------------------------------------------------------
# - APT packages: Use major.minor.* wildcards for patch updates
# - GitHub tools: Pin to release tags (vX.Y.Z)
# - Cargo/Go: Pin to exact versions (@X.Y.Z)
# - Security exceptions marked with: # UNPINNED: package - reason
# - Self-managing installers (mise, rustup, etc.) trusted to handle versions
#
# To check for updates: just check-updates
# Last version audit: 2026-01-22
# -----------------------------------------------------------------------------
```

**Build verification:**
After all changes, the Dockerfile must still build. Changes are syntax-only (adding version constraints to existing commands).
  </action>
  <verify>
grep -c "# .* v[0-9]" packages/core/src/docker/Dockerfile should show multiple version comments
grep "Version Pinning Policy" packages/core/src/docker/Dockerfile should find the header
  </verify>
  <done>All tools have inline documentation comments, Dockerfile syntax is valid</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `grep -E "@latest|/latest/download" packages/core/src/docker/Dockerfile` returns no matches
2. `grep -c "# UNPINNED:" packages/core/src/docker/Dockerfile` shows security exceptions documented
3. `grep -c "@[0-9]" packages/core/src/docker/Dockerfile` shows cargo/go version pins
4. Dockerfile syntax is valid (no build errors)
</verification>

<success_criteria>
- All GitHub-installed tools have explicit version tags (not :latest)
- Version pinning documented in Dockerfile comments
- Security exceptions explicitly marked with UNPINNED comments
- Image builds are reproducible given same Dockerfile
</success_criteria>

<output>
After completion, create `.planning/phases/09-dockerfile-version-pinning/09-01-SUMMARY.md`
</output>
