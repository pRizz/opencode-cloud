---
phase: 20-one-click-cloud-deploy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - infra/aws/cloudformation/opencode-cloud-quick.yaml
  - infra/aws/cloud-init/opencode-cloud-quick.yaml
autonomous: true

must_haves:
  truths:
    - "AWS quick deploy uses CloudFormation with Ubuntu + cloud-init and pulls the opencode-cloud image"
    - "ALB + ACM HTTPS is the default with domain required"
    - "ALB is public; instance is private by default"
    - "Quick deploy defaults to t3.medium"
    - "Quick deploy auto-creates a strong user password and outputs credentials"
    - "Cockpit is routed behind the same ALB"
  artifacts:
    - path: "infra/aws/cloudformation/opencode-cloud-quick.yaml"
      provides: "CloudFormation template for AWS quick deploy"
    - path: "infra/aws/cloud-init/opencode-cloud-quick.yaml"
      provides: "Cloud-init script to install Docker and run opencode-cloud"
---

<objective>
Create the AWS quick deploy CloudFormation template and cloud-init script to provision a private EC2 instance behind a public ALB with ACM HTTPS, install Docker, and run the opencode-cloud sandbox image.

Purpose: Provide a one-click, HTTPS-by-default deployment path for AWS with strong default security and clear outputs.
Output: `infra/aws/cloudformation/opencode-cloud-quick.yaml` and `infra/aws/cloud-init/opencode-cloud-quick.yaml`.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-one-click-cloud-deploy/20-CONTEXT.md
@packages/core/src/docker/Dockerfile
@packages/core/src/docker/README.dockerhub.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cloud-init script for opencode-cloud</name>
  <files>infra/aws/cloud-init/opencode-cloud-quick.yaml</files>
  <action>
Create a cloud-init script that:
- Installs Docker on Ubuntu.
- Pulls the opencode-cloud sandbox image from GHCR.
- Starts the container with required ports and volumes.
- Creates an initial opencode user with a strong random password.
- Writes a small status file for output (URL, username, password).
  </action>
  <verify>
Cloud-init is idempotent, uses stable package installs, and includes clear comments.
  </verify>
  <done>
Cloud-init script exists and documents required environment variables or parameters.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CloudFormation quick deploy template</name>
  <files>infra/aws/cloudformation/opencode-cloud-quick.yaml</files>
  <action>
Create a CloudFormation template that:
- Provisions a public ALB with HTTPS listener using ACM.
- Provisions a private EC2 instance (t3.medium default) with cloud-init.
- Creates required security groups.
- Requires a domain input for ACM validation.
- Routes opencode UI and Cockpit behind the ALB.
- Outputs high-level and technical details.
  </action>
  <verify>
Template parameters include domain and optional advanced parameters (instance type, SSH key, VPC/subnets).
  </verify>
  <done>
CloudFormation template is ready for use in a deploy button.
  </done>
</task>

</tasks>
