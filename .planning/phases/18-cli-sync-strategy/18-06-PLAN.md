---
phase: 18-cli-sync-strategy
plan: 06
type: execute
wave: 3
depends_on: ["18-04", "18-05"]
files_modified:
  - .github/workflows/build-cli-binaries.yml
  - .github/workflows/publish-npm.yml
  - pnpm-workspace.yaml
autonomous: true

must_haves:
  truths:
    - "CI builds Rust CLI for all six target platforms"
    - "CI places binaries in correct platform package directories"
    - "Publish workflow publishes platform packages before main package"
    - "Platform packages registered in pnpm workspace"
    - "Artifact flow verified: build workflow uploads, publish workflow downloads in same run context"
  artifacts:
    - path: ".github/workflows/build-cli-binaries.yml"
      provides: "Cross-platform binary build workflow"
      contains: "aarch64-apple-darwin"
    - path: ".github/workflows/publish-npm.yml"
      provides: "Updated publish workflow for platform packages"
      contains: "cli-darwin-arm64"
  key_links:
    - from: ".github/workflows/build-cli-binaries.yml"
      to: "packages/cli-*/bin/"
      via: "artifact upload/download"
      pattern: "upload-artifact|download-artifact"
---

<objective>
Create GitHub Actions workflow to build Rust CLI binaries for all platforms and update publish workflow to include platform packages.

Purpose: Automate cross-platform binary compilation so every release includes prebuilt binaries. When maintainers push a version tag, CI builds binaries for all platforms and publishes them as separate npm packages.

Output: GitHub Actions workflow for cross-compilation and updated npm publish workflow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-cli-sync-strategy/18-CONTEXT.md
@.planning/phases/18-cli-sync-strategy/18-RESEARCH.md
@.planning/phases/18-cli-sync-strategy/18-04-SUMMARY.md
@.planning/phases/18-cli-sync-strategy/18-05-SUMMARY.md
@.github/workflows/ci.yml
@.github/workflows/publish-npm.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cross-platform binary build workflow</name>
  <files>.github/workflows/build-cli-binaries.yml</files>
  <action>
Create `.github/workflows/build-cli-binaries.yml` for building Rust CLI binaries.

**Important:** When called via `workflow_call`, artifacts uploaded in the called workflow are available to the calling workflow's subsequent jobs. This works because they share the same workflow run context.

```yaml
name: Build CLI Binaries

on:
  workflow_call:
    # Called by publish workflow - artifacts are shared in same workflow run
  workflow_dispatch:
    # Manual trigger for testing

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build (${{ matrix.target }})
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS ARM64 (Apple Silicon)
          - target: aarch64-apple-darwin
            os: macos-latest
            package: cli-darwin-arm64
          # macOS x64 (Intel)
          - target: x86_64-apple-darwin
            os: macos-latest
            package: cli-darwin-x64
          # Linux x64 (glibc)
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            package: cli-linux-x64
          # Linux ARM64 (glibc) - use cross for ARM compilation
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            package: cli-linux-arm64
            use-cross: true
          # Linux x64 (musl/Alpine)
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            package: cli-linux-x64-musl
          # Linux ARM64 (musl/Alpine) - use cross for ARM + musl
          - target: aarch64-unknown-linux-musl
            os: ubuntu-latest
            package: cli-linux-arm64-musl
            use-cross: true

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross (for ARM targets)
        if: matrix.use-cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Install musl-tools (for musl x64)
        if: matrix.target == 'x86_64-unknown-linux-musl'
        run: sudo apt-get update && sudo apt-get install -y musl-tools

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}

      - name: Build binary
        run: |
          if [ "${{ matrix.use-cross }}" = "true" ]; then
            cross build --release --target ${{ matrix.target }} -p opencode-cloud
          else
            cargo build --release --target ${{ matrix.target }} -p opencode-cloud
          fi

      - name: Prepare binary
        run: |
          mkdir -p packages/${{ matrix.package }}/bin
          cp target/${{ matrix.target }}/release/occ packages/${{ matrix.package }}/bin/occ
          chmod +x packages/${{ matrix.package }}/bin/occ

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.package }}
          path: packages/${{ matrix.package }}/bin/occ
          retention-days: 1
```

Key design decisions:
- Use `cross` for ARM targets (no native ARM GitHub runners)
- macOS can native compile both x64 and ARM64
- musl x64 needs musl-tools installed
- Each artifact named by package for easy download
- 1-day retention (artifacts only needed during release)
  </action>
  <verify>
`cat .github/workflows/build-cli-binaries.yml` shows matrix with all six targets.
  </verify>
  <done>
build-cli-binaries.yml workflow compiles Rust CLI for all six platforms.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update pnpm workspace to include platform packages</name>
  <files>pnpm-workspace.yaml</files>
  <action>
Update `pnpm-workspace.yaml` to include the platform packages:

Read the current file and add the platform packages to the packages list:

```yaml
packages:
  - 'packages/core'
  - 'packages/cli-node'
  - 'packages/cli-rust'
  - 'packages/cli-darwin-arm64'
  - 'packages/cli-darwin-x64'
  - 'packages/cli-linux-arm64'
  - 'packages/cli-linux-x64'
  - 'packages/cli-linux-arm64-musl'
  - 'packages/cli-linux-x64-musl'
```

This allows pnpm to manage versions and publish all packages together.
  </action>
  <verify>
`cat pnpm-workspace.yaml` shows all platform packages listed.
  </verify>
  <done>
pnpm workspace includes all six platform packages.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update npm publish workflow for platform packages</name>
  <files>.github/workflows/publish-npm.yml</files>
  <action>
Update `.github/workflows/publish-npm.yml` to:
1. Call build-cli-binaries workflow first
2. Download artifacts into platform package directories
3. Publish platform packages before main package

```yaml
name: Publish to npm

on:
  workflow_call:
    inputs:
      version:
        description: 'Version being published'
        required: true
        type: string

jobs:
  build-binaries:
    name: Build CLI Binaries
    uses: ./.github/workflows/build-cli-binaries.yml

  publish:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: [build-binaries]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install Node dependencies
        run: pnpm install --frozen-lockfile

      # Download all binary artifacts
      - name: Download darwin-arm64 binary
        uses: actions/download-artifact@v4
        with:
          name: cli-darwin-arm64
          path: packages/cli-darwin-arm64/bin

      - name: Download darwin-x64 binary
        uses: actions/download-artifact@v4
        with:
          name: cli-darwin-x64
          path: packages/cli-darwin-x64/bin

      - name: Download linux-x64 binary
        uses: actions/download-artifact@v4
        with:
          name: cli-linux-x64
          path: packages/cli-linux-x64/bin

      - name: Download linux-arm64 binary
        uses: actions/download-artifact@v4
        with:
          name: cli-linux-arm64
          path: packages/cli-linux-arm64/bin

      - name: Download linux-x64-musl binary
        uses: actions/download-artifact@v4
        with:
          name: cli-linux-x64-musl
          path: packages/cli-linux-x64-musl/bin

      - name: Download linux-arm64-musl binary
        uses: actions/download-artifact@v4
        with:
          name: cli-linux-arm64-musl
          path: packages/cli-linux-arm64-musl/bin

      - name: Make binaries executable
        run: |
          chmod +x packages/cli-darwin-arm64/bin/occ
          chmod +x packages/cli-darwin-x64/bin/occ
          chmod +x packages/cli-linux-x64/bin/occ
          chmod +x packages/cli-linux-arm64/bin/occ
          chmod +x packages/cli-linux-x64-musl/bin/occ
          chmod +x packages/cli-linux-arm64-musl/bin/occ

      - name: Build Node packages
        run: |
          pnpm -C packages/core build
          pnpm -C packages/cli-node build

      # Publish platform packages first (main package depends on them)
      - name: Publish @opencode-cloud/cli-darwin-arm64
        run: pnpm --filter @opencode-cloud/cli-darwin-arm64 publish --access public --provenance --no-git-checks

      - name: Publish @opencode-cloud/cli-darwin-x64
        run: pnpm --filter @opencode-cloud/cli-darwin-x64 publish --access public --provenance --no-git-checks

      - name: Publish @opencode-cloud/cli-linux-x64
        run: pnpm --filter @opencode-cloud/cli-linux-x64 publish --access public --provenance --no-git-checks

      - name: Publish @opencode-cloud/cli-linux-arm64
        run: pnpm --filter @opencode-cloud/cli-linux-arm64 publish --access public --provenance --no-git-checks

      - name: Publish @opencode-cloud/cli-linux-x64-musl
        run: pnpm --filter @opencode-cloud/cli-linux-x64-musl publish --access public --provenance --no-git-checks

      - name: Publish @opencode-cloud/cli-linux-arm64-musl
        run: pnpm --filter @opencode-cloud/cli-linux-arm64-musl publish --access public --provenance --no-git-checks

      - name: Wait for npm to index platform packages
        run: sleep 30

      # Publish main packages
      - name: Publish @opencode-cloud/core
        run: pnpm --filter @opencode-cloud/core publish --access public --provenance --no-git-checks

      - name: Wait for npm to index
        run: sleep 10

      - name: Publish opencode-cloud
        run: pnpm --filter opencode-cloud publish --access public --provenance --no-git-checks

      - name: Summary
        run: |
          echo "## Published to npm" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platform Packages:**" >> $GITHUB_STEP_SUMMARY
          echo "- [@opencode-cloud/cli-darwin-arm64](https://www.npmjs.com/package/@opencode-cloud/cli-darwin-arm64)" >> $GITHUB_STEP_SUMMARY
          echo "- [@opencode-cloud/cli-darwin-x64](https://www.npmjs.com/package/@opencode-cloud/cli-darwin-x64)" >> $GITHUB_STEP_SUMMARY
          echo "- [@opencode-cloud/cli-linux-x64](https://www.npmjs.com/package/@opencode-cloud/cli-linux-x64)" >> $GITHUB_STEP_SUMMARY
          echo "- [@opencode-cloud/cli-linux-arm64](https://www.npmjs.com/package/@opencode-cloud/cli-linux-arm64)" >> $GITHUB_STEP_SUMMARY
          echo "- [@opencode-cloud/cli-linux-x64-musl](https://www.npmjs.com/package/@opencode-cloud/cli-linux-x64-musl)" >> $GITHUB_STEP_SUMMARY
          echo "- [@opencode-cloud/cli-linux-arm64-musl](https://www.npmjs.com/package/@opencode-cloud/cli-linux-arm64-musl)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Main Packages:**" >> $GITHUB_STEP_SUMMARY
          echo "- [@opencode-cloud/core](https://www.npmjs.com/package/@opencode-cloud/core)" >> $GITHUB_STEP_SUMMARY
          echo "- [opencode-cloud](https://www.npmjs.com/package/opencode-cloud)" >> $GITHUB_STEP_SUMMARY
```

Key design decisions:
- Build binaries in parallel first via workflow_call (artifacts shared in same workflow run context)
- Download each artifact to its package directory (actions/download-artifact@v4 works across jobs in same run)
- 30-second wait for npm to index platform packages before publishing main
- Provenance enabled for supply chain security
- Summary shows all published packages

**Note on artifact flow:** When using `workflow_call`, the called workflow's jobs run as part of the calling workflow's run. Artifacts uploaded in build-cli-binaries.yml are accessible via download-artifact in publish-npm.yml because they're in the same workflow run context. This is different from `workflow_dispatch` which creates a separate run.
  </action>
  <verify>
`cat .github/workflows/publish-npm.yml` shows build-binaries call and all platform package publishes.
  </verify>
  <done>
publish-npm.yml builds binaries, downloads artifacts, publishes platform packages, then main packages.
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. build-cli-binaries.yml exists with six-target matrix
2. pnpm-workspace.yaml includes all platform packages
3. publish-npm.yml calls build workflow and downloads artifacts
4. Platform packages published before main package
5. All workflows use correct artifact paths
</verification>

<success_criteria>
- GitHub Actions can build Rust CLI for all six platforms
- Cross-compilation works for ARM targets using `cross`
- Binary artifacts flow from build to publish workflow
- npm publish order: platform packages first, then main packages
- Users can `npm install opencode-cloud` and get working binary immediately
</success_criteria>

<output>
After completion, create `.planning/phases/18-cli-sync-strategy/18-06-SUMMARY.md`
</output>
