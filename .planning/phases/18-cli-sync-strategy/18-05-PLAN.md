---
phase: 18-cli-sync-strategy
plan: 05
type: execute
wave: 2
depends_on: ["18-04"]
files_modified:
  - packages/cli-node/package.json
  - packages/cli-node/src/index.ts
  - packages/cli-node/README.md
autonomous: true

must_haves:
  truths:
    - "Main package has optionalDependencies pointing to all platform packages"
    - "Binary resolution tries platform package first, falls back to local bin/"
    - "User sees helpful error if no binary found and no fallback available"
  artifacts:
    - path: "packages/cli-node/package.json"
      provides: "Main CLI package with optionalDependencies"
      contains: '"optionalDependencies"'
    - path: "packages/cli-node/src/index.ts"
      provides: "Binary resolution with platform package fallback"
      min_lines: 50
  key_links:
    - from: "packages/cli-node/src/index.ts"
      to: "platform packages"
      via: "require() to find binaryPath"
      pattern: "require.*cli-(darwin|linux)"
---

<objective>
Update the main cli-node package to use optionalDependencies for platform binary distribution.

Purpose: Transform the cli-node package from requiring a pre-placed binary to automatically finding the binary from npm-installed platform-specific packages. Users running `npm install opencode-cloud` will get the correct binary for their platform without needing Rust installed.

Output: Updated package.json with optionalDependencies and index.ts with platform-aware binary resolution.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-cli-sync-strategy/18-CONTEXT.md
@.planning/phases/18-cli-sync-strategy/18-RESEARCH.md
@.planning/phases/18-cli-sync-strategy/18-04-SUMMARY.md
@packages/cli-node/package.json
@packages/cli-node/src/index.ts
@packages/core/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add optionalDependencies to package.json</name>
  <files>packages/cli-node/package.json</files>
  <action>
Update packages/cli-node/package.json to add optionalDependencies for all platform packages:

1. Add optionalDependencies section after devDependencies:
```json
"optionalDependencies": {
  "@opencode-cloud/cli-darwin-arm64": "3.0.0",
  "@opencode-cloud/cli-darwin-x64": "3.0.0",
  "@opencode-cloud/cli-linux-arm64": "3.0.0",
  "@opencode-cloud/cli-linux-x64": "3.0.0",
  "@opencode-cloud/cli-linux-arm64-musl": "3.0.0",
  "@opencode-cloud/cli-linux-x64-musl": "3.0.0"
}
```

2. Update description to reflect the new distribution model:
```json
"description": "Cross-platform CLI for opencode-cloud (includes prebuilt binaries)"
```

3. Keep the "files" array including "bin" for development/fallback scenarios.

Note: npm will automatically install only the package matching the user's platform based on os, cpu, and libc fields.
  </action>
  <verify>
`cat packages/cli-node/package.json | grep -A 10 optionalDependencies` shows all six platform packages.
  </verify>
  <done>
package.json has optionalDependencies for all six platform packages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update index.ts for platform-aware binary resolution</name>
  <files>packages/cli-node/src/index.ts</files>
  <action>
Rewrite packages/cli-node/src/index.ts to resolve binary from optionalDependencies:

```typescript
#!/usr/bin/env node
/**
 * opencode-cloud Node.js CLI
 *
 * Resolves the platform-specific binary from optionalDependencies,
 * with fallback to local bin/ for development.
 */

import { spawn } from 'child_process';
import { existsSync } from 'fs';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';
import { createRequire } from 'module';

const require = createRequire(import.meta.url);
const scriptDir = dirname(fileURLToPath(import.meta.url));

/**
 * Detect if running on musl libc (Alpine Linux)
 */
function isMusl(): boolean {
  // Check for Alpine-specific file
  if (existsSync('/etc/alpine-release')) {
    return true;
  }
  // Check ldd output for musl
  try {
    const { execSync } = await import('child_process');
    const lddPath = execSync('which ldd', { encoding: 'utf-8' }).trim();
    const lddOutput = require('fs').readFileSync(lddPath, 'utf-8');
    return lddOutput.includes('musl');
  } catch {
    return false;
  }
}

/**
 * Get the platform package name for the current environment
 */
function getPlatformPackage(): string | null {
  const { platform, arch } = process;

  if (platform === 'darwin') {
    return arch === 'arm64'
      ? '@opencode-cloud/cli-darwin-arm64'
      : '@opencode-cloud/cli-darwin-x64';
  }

  if (platform === 'linux') {
    const musl = isMusl();
    if (arch === 'x64') {
      return musl
        ? '@opencode-cloud/cli-linux-x64-musl'
        : '@opencode-cloud/cli-linux-x64';
    }
    if (arch === 'arm64') {
      return musl
        ? '@opencode-cloud/cli-linux-arm64-musl'
        : '@opencode-cloud/cli-linux-arm64';
    }
  }

  return null; // Unsupported platform
}

/**
 * Resolve path to the occ binary
 */
function resolveBinaryPath(): string | null {
  // Try 1: Platform package from optionalDependencies
  const platformPkg = getPlatformPackage();
  if (platformPkg) {
    try {
      const pkg = require(platformPkg);
      if (pkg.binaryPath && existsSync(pkg.binaryPath)) {
        return pkg.binaryPath;
      }
    } catch {
      // Package not installed, try fallback
    }
  }

  // Try 2: Local bin/ directory (development/CI)
  const localBinary = join(scriptDir, '..', 'bin', 'occ');
  if (existsSync(localBinary)) {
    return localBinary;
  }

  return null;
}

// Resolve binary
const binaryPath = resolveBinaryPath();

if (!binaryPath) {
  const platformPkg = getPlatformPackage();
  console.error('Error: Could not find opencode-cloud binary\n');
  console.error(`Platform: ${process.platform} (${process.arch})`);
  if (platformPkg) {
    console.error(`Expected package: ${platformPkg}\n`);
    console.error('This may indicate a failed npm install. Try:');
    console.error('  npm install opencode-cloud\n');
  } else {
    console.error('\nYour platform is not supported with prebuilt binaries.');
    console.error('Install the Rust CLI directly:');
    console.error('  cargo install opencode-cloud\n');
  }
  process.exit(1);
}

// Spawn the binary with all arguments passed through
const child = spawn(binaryPath, process.argv.slice(2), {
  stdio: 'inherit',
});

child.on('close', (code) => {
  process.exit(code ?? 1);
});

child.on('error', (err) => {
  console.error(`Error: Failed to spawn binary at ${binaryPath}`);
  console.error(`Error: ${err.message}\n`);
  console.error('Try reinstalling: npm install opencode-cloud');
  process.exit(1);
});
```

Key design decisions:
- isMusl() detects Alpine Linux for musl binary selection
- Platform package resolution via require() follows npm's node_modules structure
- Fallback to local bin/ preserves development and CI workflows
- Clear error messages guide users on what to do
  </action>
  <verify>
`pnpm -C packages/cli-node build` compiles successfully.
  </verify>
  <done>
index.ts resolves binary from optionalDependencies platform packages with local bin/ fallback.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update README for prebuilt binary distribution</name>
  <files>packages/cli-node/README.md</files>
  <action>
Update packages/cli-node/README.md to document the new distribution model:

1. Update the introduction to mention prebuilt binaries:
```markdown
# opencode-cloud Node.js CLI

Cross-platform CLI for opencode-cloud with prebuilt binaries for major platforms.

## Installation

```bash
npm install -g opencode-cloud
# or
npx opencode-cloud --version
```

No Rust toolchain required - npm automatically downloads the correct binary for your platform.
```

2. Add "Supported Platforms" section:
```markdown
## Supported Platforms

| Platform | Architecture | Package |
|----------|--------------|---------|
| macOS | Apple Silicon (arm64) | @opencode-cloud/cli-darwin-arm64 |
| macOS | Intel (x64) | @opencode-cloud/cli-darwin-x64 |
| Linux | x64 (glibc) | @opencode-cloud/cli-linux-x64 |
| Linux | ARM64 (glibc) | @opencode-cloud/cli-linux-arm64 |
| Linux | x64 (musl/Alpine) | @opencode-cloud/cli-linux-x64-musl |
| Linux | ARM64 (musl/Alpine) | @opencode-cloud/cli-linux-arm64-musl |

Windows support planned for a future release.
```

3. Keep the "How it works" section but update it to mention platform resolution:
```markdown
## How it works

1. When you install `opencode-cloud`, npm downloads a platform-specific package based on your OS and architecture
2. The main package finds the binary from the platform package
3. All CLI invocations spawn the Rust binary with transparent passthrough (stdio: inherit)
4. Exit codes, colors, and TTY detection are preserved
```

4. Keep "Development" section for contributors with local binary placement info.

5. Remove outdated text about requiring Rust for installation.
  </action>
  <verify>
`cat packages/cli-node/README.md` shows updated installation instructions and platform table.
  </verify>
  <done>
README.md documents prebuilt binary distribution and supported platforms.
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. package.json has optionalDependencies with all six platform packages
2. index.ts has platform detection and resolution logic
3. index.ts falls back to local bin/ for development
4. README.md documents the distribution model
5. `pnpm -C packages/cli-node build` succeeds
</verification>

<success_criteria>
- npm install on macOS ARM64 will get @opencode-cloud/cli-darwin-arm64
- npm install on Linux x64 will get @opencode-cloud/cli-linux-x64
- Binary resolution works without user configuration
- Development workflow (local bin/) still works
- Clear error message when platform unsupported
</success_criteria>

<output>
After completion, create `.planning/phases/18-cli-sync-strategy/18-05-SUMMARY.md`
</output>
