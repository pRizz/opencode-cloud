---
phase: 18-cli-sync-strategy
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - packages/cli-node/src/cli-parity.test.ts
  - packages/cli-node/package.json
  - packages/cli-node/vitest.config.ts
  - .github/workflows/ci.yml
autonomous: true

must_haves:
  truths:
    - "Parity tests discover commands dynamically from Rust CLI help"
    - "Tests verify Node CLI passthrough works for all commands"
    - "CI fails when Node CLI cannot invoke a Rust CLI command"
    - "Test suite runs in CI on every PR"
  artifacts:
    - path: "packages/cli-node/src/cli-parity.test.ts"
      provides: "Dynamic command discovery and passthrough verification tests"
      min_lines: 40
    - path: "packages/cli-node/vitest.config.ts"
      provides: "Vitest configuration for running tests"
      min_lines: 5
    - path: ".github/workflows/ci.yml"
      provides: "CI job that runs parity tests"
      contains: "cli-parity"
  key_links:
    - from: "packages/cli-node/src/cli-parity.test.ts"
      to: "Rust CLI"
      via: "execSync to parse help output"
      pattern: "cargo run.*--help"
---

<objective>
Create a parity test suite that dynamically discovers Rust CLI commands and verifies the Node CLI can invoke each one.

Purpose: Ensures the Rust CLI and Node CLI stay in sync automatically. When a new command is added to Rust, tests will verify it works through Node without requiring manual test updates.

Output: A working test suite that parses `occ --help` to discover commands, tests each through the Node wrapper, and integrates with CI to block merges when parity breaks.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-cli-sync-strategy/18-CONTEXT.md
@.planning/phases/18-cli-sync-strategy/18-RESEARCH.md
@.github/workflows/ci.yml
@packages/cli-node/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Vitest and create parity test suite</name>
  <files>packages/cli-node/package.json, packages/cli-node/vitest.config.ts, packages/cli-node/src/cli-parity.test.ts</files>
  <action>
1. Update packages/cli-node/package.json:
   - Add vitest to devDependencies: `"vitest": "^3.0.0"`
   - Add test script: `"test": "vitest run"`
   - Add test:watch script: `"test:watch": "vitest"`

2. Create packages/cli-node/vitest.config.ts:
```typescript
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    include: ['src/**/*.test.ts'],
    testTimeout: 30000, // Commands may take time
  },
});
```

3. Create packages/cli-node/src/cli-parity.test.ts with:

```typescript
import { describe, test, expect, beforeAll } from 'vitest';
import { execSync, spawnSync } from 'child_process';
import { existsSync, copyFileSync, chmodSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __dirname = dirname(fileURLToPath(import.meta.url));
const binDir = join(__dirname, '..', 'bin');
const binPath = join(binDir, 'occ');

describe('CLI Parity', () => {
  beforeAll(() => {
    // Ensure Node CLI is built
    execSync('pnpm build', { cwd: join(__dirname, '..'), stdio: 'inherit' });

    // Check if binary exists, if not try to build it
    if (!existsSync(binPath)) {
      // Try to copy from cargo build output
      const cargoBin = join(__dirname, '..', '..', '..', 'target', 'release', 'occ');
      const cargoDebugBin = join(__dirname, '..', '..', '..', 'target', 'debug', 'occ');

      if (existsSync(cargoBin)) {
        copyFileSync(cargoBin, binPath);
        chmodSync(binPath, 0o755);
      } else if (existsSync(cargoDebugBin)) {
        copyFileSync(cargoDebugBin, binPath);
        chmodSync(binPath, 0o755);
      } else {
        // Build it
        execSync('cargo build -p opencode-cloud', {
          cwd: join(__dirname, '..', '..', '..'),
          stdio: 'inherit'
        });
        if (existsSync(cargoDebugBin)) {
          copyFileSync(cargoDebugBin, binPath);
          chmodSync(binPath, 0o755);
        }
      }
    }
  });

  test('Binary exists and is executable', () => {
    expect(existsSync(binPath)).toBe(true);
  });

  test('Node CLI --version works', () => {
    const result = spawnSync('node', [join(__dirname, '..', 'dist', 'index.js'), '--version'], {
      encoding: 'utf8',
      timeout: 10000,
    });
    expect(result.status).toBe(0);
    expect(result.stdout).toContain('opencode-cloud');
  });

  test('Node CLI --help works', () => {
    const result = spawnSync('node', [join(__dirname, '..', 'dist', 'index.js'), '--help'], {
      encoding: 'utf8',
      timeout: 10000,
    });
    expect(result.status).toBe(0);
    expect(result.stdout).toContain('Commands:');
  });

  describe('Dynamic command discovery', () => {
    let commands: string[] = [];

    beforeAll(() => {
      // Discover commands from Rust CLI help output
      const result = spawnSync(binPath, ['--help'], { encoding: 'utf8', timeout: 10000 });
      if (result.status !== 0) {
        throw new Error(`Failed to get help: ${result.stderr}`);
      }

      // Parse commands from help output
      // Clap format: "Commands:\n  start    Description\n  stop     Description"
      const helpOutput = result.stdout;
      const commandsMatch = helpOutput.match(/Commands:\n([\s\S]*?)(?:\n\nOptions:|$)/);
      if (!commandsMatch) {
        throw new Error('Could not parse commands from help output');
      }

      commands = commandsMatch[1]
        .split('\n')
        .map(line => line.trim())
        .filter(line => line && !line.startsWith('help'))
        .map(line => line.split(/\s+/)[0])
        .filter(Boolean);

      expect(commands.length).toBeGreaterThan(0);
    });

    test('All Rust CLI commands available via Node CLI', () => {
      for (const cmd of commands) {
        const result = spawnSync('node', [
          join(__dirname, '..', 'dist', 'index.js'),
          cmd,
          '--help'
        ], {
          encoding: 'utf8',
          timeout: 10000,
        });

        // Command should succeed (exit 0) or fail gracefully (help shown)
        // Some commands may need prerequisites (container running, etc.)
        // so we just verify it doesn't crash with "unknown command"
        expect(result.stderr).not.toContain('unrecognized subcommand');
        expect(result.stderr).not.toContain('error: unrecognized');
      }
    });
  });
});
```

The test:
- Automatically builds the Node CLI
- Copies Rust binary if available (from target/debug or target/release)
- Discovers commands dynamically from `occ --help`
- Verifies each command is accessible through Node wrapper
  </action>
  <verify>
Run `pnpm -C packages/cli-node test` (will fail until binary placed, but vitest should load).
  </verify>
  <done>
Vitest configured, cli-parity.test.ts discovers commands dynamically and tests Node CLI passthrough.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CLI parity job to CI workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Add a new job to the existing CI workflow that:

1. Runs after the build job (needs: [build])
2. Downloads/builds Rust binary
3. Places it in packages/cli-node/bin/
4. Runs the parity tests

Add this job after the existing `build` job:

```yaml
  # CLI parity check - verifies Node CLI can invoke all Rust CLI commands
  cli-parity:
    name: CLI Parity Check
    runs-on: ubuntu-latest
    needs: [build]  # Ensure build passes first
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.88"

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install Node dependencies
        run: pnpm install

      - name: Build Rust CLI
        run: cargo build --release -p opencode-cloud

      - name: Place binary for Node CLI
        run: |
          mkdir -p packages/cli-node/bin
          cp target/release/occ packages/cli-node/bin/occ
          chmod +x packages/cli-node/bin/occ

      - name: Build Node CLI
        run: pnpm -C packages/cli-node build

      - name: Run parity tests
        run: pnpm -C packages/cli-node test
```

This ensures:
- Every PR runs parity tests
- CI fails if Node CLI can't invoke Rust commands
- No drift between CLIs can be merged
  </action>
  <verify>
Review .github/workflows/ci.yml to confirm cli-parity job exists with correct steps.
  </verify>
  <done>
CI workflow has cli-parity job that builds binary, places it, and runs tests.
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `pnpm -C packages/cli-node test` runs (may fail without binary, but vitest loads)
2. packages/cli-node/vitest.config.ts exists
3. packages/cli-node/src/cli-parity.test.ts has dynamic command discovery
4. .github/workflows/ci.yml has cli-parity job that depends on build
</verification>

<success_criteria>
- Test suite dynamically discovers commands from `occ --help`
- Tests verify Node CLI can invoke each discovered command
- CI workflow includes parity job that fails build on drift
- No hardcoded command list - automatically adapts when new commands added
</success_criteria>

<output>
After completion, create `.planning/phases/18-cli-sync-strategy/18-02-SUMMARY.md`
</output>
