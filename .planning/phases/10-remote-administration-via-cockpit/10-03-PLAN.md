---
phase: 10-remote-administration-via-cockpit
plan: 03
type: execute
wave: 3
depends_on: ["10-02"]
files_modified:
  - packages/cli-rust/src/commands/mod.rs
  - packages/cli-rust/src/commands/cockpit.rs
  - packages/cli-rust/src/commands/status.rs
  - packages/cli-rust/src/commands/start.rs
  - packages/cli-rust/src/main.rs
autonomous: true

must_haves:
  truths:
    - "User can run `occ cockpit` to open Cockpit in browser"
    - "User sees Cockpit URL in `occ status` output"
    - "User sees Cockpit availability message after `occ start`"
    - "`occ cockpit` shows helpful error if container not running"
  artifacts:
    - path: "packages/cli-rust/src/commands/cockpit.rs"
      provides: "occ cockpit command implementation"
      exports: ["cmd_cockpit", "CockpitArgs"]
    - path: "packages/cli-rust/src/commands/status.rs"
      provides: "Cockpit URL in status output"
      contains: "Cockpit"
    - path: "packages/cli-rust/src/commands/start.rs"
      provides: "Cockpit availability message"
      contains: "Cockpit"
  key_links:
    - from: "main.rs Commands enum"
      to: "cockpit.rs cmd_cockpit"
      via: "clap subcommand"
      pattern: "Cockpit.*CockpitArgs"
    - from: "status.rs"
      to: "config.cockpit_port"
      via: "config loading"
      pattern: "cockpit_port"
---

<objective>
Add CLI commands and output for Cockpit integration

Purpose: Expose Cockpit to users through the CLI - a dedicated `occ cockpit` command to open the console, Cockpit URL in status output, and availability message after start.

Output: New cockpit command, updated status and start commands showing Cockpit info
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-remote-administration-via-cockpit/10-CONTEXT.md
@.planning/phases/10-remote-administration-via-cockpit/10-RESEARCH.md
@packages/cli-rust/src/commands/mod.rs
@packages/cli-rust/src/commands/status.rs
@packages/cli-rust/src/commands/start.rs
@packages/cli-rust/src/main.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create occ cockpit command</name>
  <files>packages/cli-rust/src/commands/cockpit.rs, packages/cli-rust/src/commands/mod.rs</files>
  <action>
Create a new cockpit.rs command file:

```rust
//! Cockpit command implementation
//!
//! Opens the Cockpit web console in the default browser.

use anyhow::{Result, bail};
use clap::Args;
use console::style;
use opencode_cloud_core::config::load_config;
use opencode_cloud_core::docker::{CONTAINER_NAME, DockerClient, container_is_running};

/// Arguments for the cockpit command
#[derive(Args)]
pub struct CockpitArgs {}

/// Open Cockpit web console in browser
///
/// This command:
/// 1. Checks if the container is running
/// 2. Checks if Cockpit is enabled in config
/// 3. Opens the Cockpit URL in the default browser
pub async fn cmd_cockpit(_args: &CockpitArgs, quiet: bool) -> Result<()> {
    // Load config
    let config = load_config()?;

    // Check if Cockpit is enabled
    if !config.cockpit_enabled {
        bail!(
            "{}\n\n\
             Cockpit is disabled in configuration.\n\n\
             Enable it with: {}\n\
             Then rebuild:   {}",
            style("Cockpit is disabled").yellow().bold(),
            style("occ config set cockpit_enabled true").cyan(),
            style("occ start --cached-rebuild").cyan()
        );
    }

    // Connect to Docker and check container status
    let client = DockerClient::new().map_err(|e| anyhow::anyhow!("{}", e))?;
    client.verify_connection().await.map_err(|e| anyhow::anyhow!("{}", e))?;

    let running = container_is_running(&client, CONTAINER_NAME).await?;
    if !running {
        bail!(
            "{}\n\n\
             The container is not running. Cockpit runs inside the container.\n\n\
             Start the container: {}\n\
             Then access Cockpit:  {}",
            style("Container not running").yellow().bold(),
            style("occ start").cyan(),
            style(format!("http://{}:{}", config.bind_address, config.cockpit_port)).cyan()
        );
    }

    // Build URL
    // For 0.0.0.0 or :: bind addresses, use localhost for browser
    let browser_addr = if config.bind_address == "0.0.0.0" || config.bind_address == "::" {
        "127.0.0.1"
    } else {
        &config.bind_address
    };
    let url = format!("http://{}:{}", browser_addr, config.cockpit_port);

    if !quiet {
        println!("Opening Cockpit at: {}", style(&url).cyan());
        println!();
        println!(
            "{}: Log in with users created via '{}'",
            style("Tip").dim(),
            style("occ user add").cyan()
        );
    }

    // Open in browser
    if let Err(e) = webbrowser::open(&url) {
        if !quiet {
            eprintln!(
                "{} Failed to open browser: {}",
                style("Warning:").yellow(),
                e
            );
            eprintln!("Open manually: {}", style(&url).cyan());
        }
    }

    Ok(())
}
```

Then update mod.rs to export the cockpit module:

```rust
mod cockpit;
// ... other mods ...

pub use cockpit::{CockpitArgs, cmd_cockpit};
// ... other exports ...
```
  </action>
  <verify>Verify cockpit.rs exists and mod.rs exports CockpitArgs and cmd_cockpit</verify>
  <done>occ cockpit command implemented with container and config checks</done>
</task>

<task type="auto">
  <name>Task 2: Add cockpit subcommand to main.rs</name>
  <files>packages/cli-rust/src/main.rs</files>
  <action>
Add the cockpit subcommand to the Commands enum and match arm:

1. Add to the Commands enum (alphabetically near the top with other commands):

```rust
/// Open Cockpit web console
Cockpit(commands::CockpitArgs),
```

2. Add to the match arm in the async main or run function:

```rust
Commands::Cockpit(args) => commands::cmd_cockpit(&args, cli.quiet).await,
```

Make sure the import is in place for CockpitArgs if it's explicitly imported.
  </action>
  <verify>Run `cargo build -p opencode-cloud-cli` - compiles successfully</verify>
  <done>occ cockpit subcommand registered in CLI</done>
</task>

<task type="auto">
  <name>Task 3: Update status command to show Cockpit info</name>
  <files>packages/cli-rust/src/commands/status.rs</files>
  <action>
Add Cockpit URL and status to the status output when the container is running:

1. After the existing port line in the running section, add Cockpit info:

```rust
// Show Cockpit info if enabled
if let Some(ref cfg) = config {
    if cfg.cockpit_enabled {
        // For 0.0.0.0 or :: bind addresses, use localhost for display
        let cockpit_addr = if cfg.bind_address == "0.0.0.0" || cfg.bind_address == "::" {
            "127.0.0.1"
        } else {
            &cfg.bind_address
        };
        let cockpit_url = format!("http://{}:{}", cockpit_addr, cfg.cockpit_port);
        println!(
            "Cockpit:     {} -> container:9090",
            style(&cockpit_url).cyan()
        );
    }
}
```

This should go after the Port line and before the Health line in the running section.

2. Ensure config is loaded before this section. It's already loaded for the Security section, so reuse that:

```rust
// Load config early for reuse
let config = config::load_config().ok();
```

Make sure this happens before both the running section and the security section.
  </action>
  <verify>Run `just test` - status tests pass; run `occ status` manually if container exists</verify>
  <done>occ status shows Cockpit URL when container is running and Cockpit is enabled</done>
</task>

<task type="auto">
  <name>Task 4: Update start command to mention Cockpit</name>
  <files>packages/cli-rust/src/commands/start.rs</files>
  <action>
Update show_start_result function to display Cockpit availability:

1. In show_start_result, add Cockpit info after the Port line:

```rust
fn show_start_result(
    container_id: &str,
    port: u16,
    bind_addr: &str,
    is_exposed: bool,
    quiet: bool,
) {
    // ... existing code ...

    if quiet {
        println!("{}", url);
        return;
    }

    println!();
    println!("URL:        {}", style(&url).cyan());
    println!(
        "Container:  {}",
        style(&container_id[..12.min(container_id.len())]).dim()
    );
    println!("Port:       {} -> 3000", port);

    // Show Cockpit availability
    if let Ok(config) = opencode_cloud_core::config::load_config() {
        if config.cockpit_enabled {
            let cockpit_addr = if bind_addr == "0.0.0.0" || bind_addr == "::" {
                "127.0.0.1"
            } else {
                bind_addr
            };
            println!(
                "Cockpit:    http://{}:{} (web admin)",
                cockpit_addr, config.cockpit_port
            );
        }
    }

    // Show security status
    // ... rest of existing code ...
}
```

2. Also update show_already_running to include Cockpit:

```rust
fn show_already_running(port: u16, bind_addr: &str, is_exposed: bool, quiet: bool) -> Result<()> {
    if quiet {
        return Ok(());
    }

    let url = format!("http://{}:{}", bind_addr, port);
    println!("{}", style("Service is already running").dim());
    println!();
    println!("URL:        {}", style(&url).cyan());

    // Show Cockpit URL if enabled
    if let Ok(config) = opencode_cloud_core::config::load_config() {
        if config.cockpit_enabled {
            let cockpit_addr = if bind_addr == "0.0.0.0" || bind_addr == "::" {
                "127.0.0.1"
            } else {
                bind_addr
            };
            println!(
                "Cockpit:    http://{}:{} (web admin)",
                cockpit_addr, config.cockpit_port
            );
        }
    }

    // Show security status
    // ... rest of existing code ...
}
```
  </action>
  <verify>Run `just build` - compiles; verify output format by reading the code</verify>
  <done>occ start output shows Cockpit URL when enabled</done>
</task>

</tasks>

<verification>
1. `occ cockpit --help` shows command description
2. `occ cockpit` when container not running shows helpful error with instructions
3. `occ cockpit` when Cockpit disabled shows enable instructions
4. `occ status` shows Cockpit URL when container running and Cockpit enabled
5. `occ start` output includes Cockpit URL when enabled
6. All tests pass: `just test`
7. Build succeeds: `just build`
</verification>

<success_criteria>
- New `occ cockpit` command opens Cockpit in browser
- Cockpit URL shown in `occ status` when running
- Cockpit mentioned in `occ start` output
- Helpful errors guide users when container not running or Cockpit disabled
</success_criteria>

<output>
After completion, create `.planning/phases/10-remote-administration-via-cockpit/10-03-SUMMARY.md`
</output>
