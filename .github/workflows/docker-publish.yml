name: Docker Publish

on:
  push:
    tags:
      - 'release/v*'
  workflow_call:
    inputs:
      version:
        description: 'Version to publish (without v prefix)'
        required: true
        type: string
      ref:
        description: 'Git ref (tag or branch) to checkout'
        required: false
        type: string
        # If not provided: when triggered by tag push, uses the tag automatically;
        # when called via workflow_call, defaults to the commit that triggered the workflow
    outputs:
      scout_policy_status:
        description: 'Docker Scout policy status (pass, fail, or error)'
        value: ${{ jobs.build-and-push.outputs.scout_policy_status }}
      scout_policy_exit_code:
        description: 'Exit code returned by docker scout policy'
        value: ${{ jobs.build-and-push.outputs.scout_policy_exit_code }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  IMAGE_NAME_GHCR: ghcr.io/prizz/opencode-cloud-sandbox
  IMAGE_NAME_DOCKERHUB: ${{ vars.DOCKERHUB_USERNAME }}/opencode-cloud-sandbox

jobs:
  build-and-push:
    name: Build and Push Sandbox Docker Image
    runs-on: ubuntu-latest
    outputs:
      scout_policy_status: ${{ steps.scout-policy.outputs.status }}
      scout_policy_exit_code: ${{ steps.scout-policy.outputs.exit_code }}
    permissions:
      contents: read
      packages: write  # Required for GHCR push

    steps:
      - name: Disk + Docker usage
        run: |
          df -h
          df -i
          docker system df || true

      - name: Free disk space
        run: |
          set -euo pipefail
          echo "Before:"
          df -h
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo rm -rf /usr/local/share/boost || true
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          sudo rm -rf "$AGENT_TOOLSDIRECTORY" || true
          docker system prune -af || true
          echo "After:"
          df -h

      - uses: actions/checkout@v6
        with:
          # If ref is not provided: when triggered by tag push, checkout uses the tag automatically;
          # when called via workflow_call, defaults to the commit that triggered the workflow
          ref: ${{ inputs.ref }}

      # NOTE: We parse the description label from the Dockerfile so the
      # multi-arch manifest annotation stays in sync and GHCR shows a description.
      # If you change the label format or quoting, update the extraction logic.
      - name: Extract OCI description
        id: oci-description
        run: |
          set -euo pipefail
          description="$(python3 scripts/extract-oci-description.py packages/core/src/docker/Dockerfile)"
          echo "description=${description}" >> "$GITHUB_OUTPUT"

      - name: Extract version
        id: version
        run: |
          # Use input if called via workflow_call, otherwise extract from tag
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            TAG="${GITHUB_REF_NAME}"
            VERSION="${TAG#release/}"  # Remove release/ prefix if present
            VERSION="${VERSION#v}"     # Remove v prefix
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Building version: ${VERSION}"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract Dockerfile from embedded location
        run: |
          # The Dockerfile is embedded in the Rust source
          cp packages/core/src/docker/Dockerfile .

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.IMAGE_NAME_GHCR }}
            ${{ env.IMAGE_NAME_DOCKERHUB }}
          tags: |
            type=semver,pattern={{version}},value=${{ steps.version.outputs.version }}
            type=raw,value=latest

      # Build and test BEFORE authenticating to registries
      # If smoke test fails, we don't waste time on login steps

      - name: Build test image (amd64 only)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          platforms: linux/amd64
          build-args: |
            OPENCODE_CLOUD_VERSION=${{ steps.version.outputs.version }}
          tags: |
            ${{ env.IMAGE_NAME_GHCR }}:test
          # Separate cache scope to avoid overwriting the main publish build cache.
          # GHA cache v2 is the recommended backend going forward.
          cache-from: type=gha,scope=opencode-cloud-sandbox-test,version=2
          cache-to: type=gha,scope=opencode-cloud-sandbox-test,mode=min,version=2

      # Temporary disabled smoke test
      # - name: Smoke test - verify container starts and becomes healthy
      #   run: |
      #     echo "Starting container for smoke test..."
      #     # Note: systemd in containers requires:
      #     # - --privileged OR specific capabilities
      #     # - --cgroupns=host for cgroups v2 (GitHub Actions runners)
      #     # - rw cgroup mount for systemd to manage cgroups
      #     docker run -d \
      #       --name smoke-test \
      #       --privileged \
      #       --cgroupns=host \
      #       --tmpfs /run \
      #       --tmpfs /tmp \
      #       -v /sys/fs/cgroup:/sys/fs/cgroup:rw \
      #       -p 3000:3000 \
      #       -e USE_SYSTEMD=1 \
      #       ${{ env.IMAGE_NAME_GHCR }}:test

      #     echo "Container started, checking status..."
      #     docker ps -a --filter name=smoke-test

      #     echo "Waiting for container to become healthy (max 90 seconds)..."
      #     for i in {1..90}; do
      #       # Check if container is still running
      #       if ! docker ps --filter name=smoke-test --filter status=running -q | grep -q .; then
      #         echo "âœ— Container exited unexpectedly"
      #         echo "Container status:"
      #         docker ps -a --filter name=smoke-test
      #         echo "Container logs:"
      #         docker logs smoke-test 2>&1 || echo "(no logs)"
      #         docker rm smoke-test || true
      #         exit 1
      #       fi

      #       if curl -sf http://localhost:3000/health > /dev/null 2>&1; then
      #         echo "âœ“ Container is healthy after ${i} seconds"
      #         docker logs smoke-test --tail 20
      #         docker stop smoke-test
      #         docker rm smoke-test
      #         exit 0
      #       fi
      #       sleep 1
      #     done

      #     echo "âœ— Container failed to become healthy within 90 seconds"
      #     echo "Container status:"
      #     docker ps -a --filter name=smoke-test
      #     echo "Container logs:"
      #     docker logs smoke-test 2>&1 || echo "(no logs)"
      #     echo "Checking systemd status inside container:"
      #     docker exec smoke-test systemctl status || echo "(systemctl failed)"
      #     docker stop smoke-test || true
      #     docker rm smoke-test || true
      #     exit 1

      # Only authenticate after smoke test passes

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          build-args: |
            OPENCODE_CLOUD_VERSION=${{ steps.version.outputs.version }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          annotations: |
            org.opencontainers.image.description=${{ steps.oci-description.outputs.description }}
          sbom: true
          provenance: mode=max
          # Scoped cache prevents thrash between test and publish builds.
          # GHA cache v2 improves compatibility with the current cache API.
          cache-from: |
            type=registry,ref=${{ env.IMAGE_NAME_GHCR }}:buildcache
            type=gha,scope=opencode-cloud-sandbox,version=2
          cache-to: |
            type=registry,ref=${{ env.IMAGE_NAME_GHCR }}:buildcache,mode=max
            type=gha,scope=opencode-cloud-sandbox,mode=min,version=2

      - name: Docker Scout Quickview
        continue-on-error: true
        uses: docker/scout-action@v1
        with:
          command: quickview
          image: ${{ env.IMAGE_NAME_DOCKERHUB }}:${{ steps.version.outputs.version }}
          summary: true
          write-comment: false

      - name: Install Docker Scout CLI
        continue-on-error: true
        run: |
          set -euo pipefail
          curl -fsSL https://raw.githubusercontent.com/docker/scout-cli/main/install.sh | sh
          docker scout version

      - name: Evaluate Docker Scout Policy
        id: scout-policy
        continue-on-error: true
        run: |
          set -euo pipefail

          org="${IMAGE_NAME_DOCKERHUB%%/*}"
          if [[ -z "${org}" || "${org}" == "${IMAGE_NAME_DOCKERHUB}" ]]; then
            echo "Unable to resolve Docker Hub org from IMAGE_NAME_DOCKERHUB=${IMAGE_NAME_DOCKERHUB}" >&2
            echo "status=error" >> "${GITHUB_OUTPUT}"
            echo "exit_code=1" >> "${GITHUB_OUTPUT}"
            exit 0
          fi

          set +e
          docker scout policy \
            "${IMAGE_NAME_DOCKERHUB}:${{ steps.version.outputs.version }}" \
            --org "${org}" --exit-code
          scout_exit_code=$?
          set -e

          case "${scout_exit_code}" in
            0) scout_status="pass" ;;
            2) scout_status="fail" ;;
            *) scout_status="error" ;;
          esac

          echo "status=${scout_status}" >> "${GITHUB_OUTPUT}"
          echo "exit_code=${scout_exit_code}" >> "${GITHUB_OUTPUT}"

      - name: Summarize Docker Scout Policy
        if: always()
        env:
          VERSIONED_IMAGE: ${{ env.IMAGE_NAME_DOCKERHUB }}:${{ steps.version.outputs.version }}
          SCOUT_POLICY_STATUS: ${{ steps.scout-policy.outputs.status }}
          SCOUT_POLICY_EXIT_CODE: ${{ steps.scout-policy.outputs.exit_code }}
        run: |
          set -euo pipefail
          {
            echo "### Docker Scout Policy"
            echo "- Image: \`${VERSIONED_IMAGE}\`"
            echo "- Status: \`${SCOUT_POLICY_STATUS:-unknown}\`"
            echo "- Exit code: \`${SCOUT_POLICY_EXIT_CODE:-unknown}\`"
          } >> "${GITHUB_STEP_SUMMARY}"

      - name: Update Docker Hub description
        uses: peter-evans/dockerhub-description@v5
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: ${{ vars.DOCKERHUB_USERNAME }}/opencode-cloud-sandbox
          readme-filepath: packages/core/src/docker/README.dockerhub.md

      - name: Summary
        env:
          SCOUT_POLICY_STATUS: ${{ steps.scout-policy.outputs.status }}
          SCOUT_POLICY_EXIT_CODE: ${{ steps.scout-policy.outputs.exit_code }}
        run: |
          echo "## ðŸ³ Sandbox Docker Images Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**GHCR (GitHub Container Registry):**" >> $GITHUB_STEP_SUMMARY
          echo "- https://github.com/pRizz/opencode-cloud/pkgs/container/opencode-cloud-sandbox" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.IMAGE_NAME_GHCR }}:${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.IMAGE_NAME_GHCR }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Docker Hub:**" >> $GITHUB_STEP_SUMMARY
          echo "- https://hub.docker.com/r/${{ vars.DOCKERHUB_USERNAME }}/opencode-cloud-sandbox" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.IMAGE_NAME_DOCKERHUB }}:${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.IMAGE_NAME_DOCKERHUB }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platforms:** linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Docker Scout policy (non-blocking):** \`${SCOUT_POLICY_STATUS:-unknown}\` (exit \`${SCOUT_POLICY_EXIT_CODE:-unknown}\`)" >> $GITHUB_STEP_SUMMARY
